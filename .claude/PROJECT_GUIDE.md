# AI RAG çŸ¥è¯†åº“ç³»ç»Ÿ - å®Œæ•´å­¦ä¹ æŒ‡å—

> æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£é¡¹ç›®çš„æ ¸å¿ƒæ¶æ„ã€å…³é”®æŠ€æœ¯ç‚¹å’Œå®ç°åŸç†ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ä»£ç ã€‚

---

## ğŸ“š ç›®å½•

1. [é¡¹ç›®ç®€ä»‹](#1-é¡¹ç›®ç®€ä»‹)
2. [æ•´ä½“æ¶æ„](#2-æ•´ä½“æ¶æ„)
3. [æ ¸å¿ƒåŠŸèƒ½è¯¦è§£](#3-æ ¸å¿ƒåŠŸèƒ½è¯¦è§£)
4. [åŠ¨æ€åˆ‡æ¢å¤§æ¨¡å‹åŸç†](#4-åŠ¨æ€åˆ‡æ¢å¤§æ¨¡å‹åŸç†)
5. [RAG å·¥ä½œæµç¨‹](#5-rag-å·¥ä½œæµç¨‹)
6. [ä»£ç æ‰§è¡Œæµç¨‹](#6-ä»£ç æ‰§è¡Œæµç¨‹)
7. [å…³é”®æŠ€æœ¯ç‚¹](#7-å…³é”®æŠ€æœ¯ç‚¹)
8. [æ•°æ®åº“è®¾è®¡](#8-æ•°æ®åº“è®¾è®¡)
9. [API æ¥å£è¯´æ˜](#9-api-æ¥å£è¯´æ˜)
10. [å¸¸è§é—®é¢˜](#10-å¸¸è§é—®é¢˜)

---

## 1. é¡¹ç›®ç®€ä»‹

### 1.1 é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ª**æ”¯æŒåŠ¨æ€åˆ‡æ¢å¤§æ¨¡å‹çš„ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰çŸ¥è¯†åº“ç³»ç»Ÿ**ï¼Œå…è®¸ç”¨æˆ·ï¼š
- ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“
- ä½¿ç”¨ä¸åŒçš„å¤§æ¨¡å‹ï¼ˆOpenAIã€Ollamaã€Claudeï¼‰è¿›è¡Œå¯¹è¯
- åŸºäºçŸ¥è¯†åº“å†…å®¹ç”Ÿæˆç²¾å‡†å›ç­”
- æ— éœ€é‡å¯å³å¯åˆ‡æ¢å¤§æ¨¡å‹

### 1.2 æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Spring Boot** | 3.2.3 | åº”ç”¨æ¡†æ¶ |
| **Spring AI** | 0.8.1 | AI é›†æˆæ¡†æ¶ |
| **Java** | 17 | ç¼–ç¨‹è¯­è¨€ |
| **PostgreSQL** | æœ€æ–° | å…³ç³»å‹æ•°æ®åº“ |
| **pgvector** | æ‰©å±• | å‘é‡å­˜å‚¨ |
| **Redis** | æœ€æ–° | ç¼“å­˜ä¸é…ç½®å­˜å‚¨ |
| **Redisson** | 3.44.0 | Redis å®¢æˆ·ç«¯ |
| **Apache Tika** | - | æ–‡æ¡£è§£æ |
| **JGit** | 5.13.0 | Git ä»“åº“åˆ†æ |

### 1.3 æ ¸å¿ƒç‰¹æ€§

âœ… **åŠ¨æ€åˆ‡æ¢å¤§æ¨¡å‹** - æ— éœ€é‡å¯ï¼Œå®æ—¶åˆ‡æ¢
âœ… **å¤šæä¾›å•†æ”¯æŒ** - OpenAIã€Ollamaã€Claude
âœ… **RAG å¢å¼º** - åŸºäºçŸ¥è¯†åº“çš„ç²¾å‡†å›ç­”
âœ… **æµå¼å“åº”** - æ‰“å­—æœºæ•ˆæœï¼Œç”¨æˆ·ä½“éªŒå¥½
âœ… **DDD æ¶æ„** - é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼Œä»£ç æ¸…æ™°
âœ… **æ–‡æ¡£è§£æ** - æ”¯æŒ PDFã€Wordã€TXT
âœ… **Git ä»“åº“åˆ†æ** - è‡ªåŠ¨è§£æä»£ç ä»“åº“

---

## 2. æ•´ä½“æ¶æ„

### 2.1 DDD åˆ†å±‚æ¶æ„

é¡¹ç›®é‡‡ç”¨**é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰**ï¼Œåˆ†ä¸ºä¸‰å±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          trigger (é€‚é…å™¨å±‚)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   HTTP     â”‚  â”‚   Advice   â”‚            â”‚
â”‚  â”‚ Controller â”‚  â”‚  Exception â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          app (é¢†åŸŸå±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  Domain    â”‚  â”‚  Factory   â”‚            â”‚
â”‚  â”‚  Service   â”‚  â”‚  ChatClientâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ ä¾èµ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          api (æ¥å£å±‚)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Interface  â”‚  â”‚    DTO     â”‚            â”‚
â”‚  â”‚  Service   â”‚  â”‚  Response  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¾èµ–æ–¹å‘
```
trigger â†’ app â†’ api
```

### 2.2 æ¨¡å—è¯´æ˜

#### **api æ¨¡å—**ï¼ˆæ¥å£å±‚ï¼‰

å®šä¹‰åº”ç”¨æœåŠ¡æ¥å£å’Œæ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œæ˜¯ç³»ç»Ÿçš„å¥‘çº¦å±‚ã€‚

```
api/
â”œâ”€ IAiService.java              # AI å¯¹è¯æœåŠ¡æ¥å£
â”œâ”€ IRAGService.java             # RAG çŸ¥è¯†åº“æœåŠ¡æ¥å£
â”œâ”€ ILlmConfigService.java       # å¤§æ¨¡å‹é…ç½®æœåŠ¡æ¥å£
â”œâ”€ dto/
â”‚  â”œâ”€ LlmProviderConfigDTO.java # å¤§æ¨¡å‹é…ç½® DTO
â”‚  â””â”€ TaskProgressDTO.java      # ä»»åŠ¡è¿›åº¦ DTO
â””â”€ response/
   â””â”€ Response.java             # ç»Ÿä¸€å“åº”å¯¹è±¡
```

**èŒè´£ï¼š**
- å®šä¹‰æœåŠ¡å¥‘çº¦ï¼ˆæ¥å£ï¼‰
- å®šä¹‰æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰
- ä¸åŒ…å«ä»»ä½•å®ç°é€»è¾‘

#### **app æ¨¡å—**ï¼ˆé¢†åŸŸå±‚ï¼‰

åŒ…å«æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ã€é¢†åŸŸæœåŠ¡ã€å·¥å‚ç±»å’Œé…ç½®ã€‚

```
app/
â”œâ”€ Application.java                    # Spring Boot å¯åŠ¨ç±»
â”œâ”€ config/                             # Spring é…ç½®
â”‚  â”œâ”€ AiConfig.java                    # Spring AI é…ç½®
â”‚  â”œâ”€ RedisClientConfig.java           # Redis å®¢æˆ·ç«¯é…ç½®
â”‚  â””â”€ RedisClientConfigProperties.java # Redis é…ç½®å±æ€§
â”œâ”€ factory/                            # å·¥å‚ç±»
â”‚  â””â”€ DynamicChatClientFactory.java    # ChatClient åŠ¨æ€å·¥å‚ â­
â””â”€ service/                            # é¢†åŸŸæœåŠ¡
   â”œâ”€ AiDomainService.java             # AI å¯¹è¯ä¸šåŠ¡é€»è¾‘
   â”œâ”€ RAGDomainService.java            # RAG çŸ¥è¯†åº“ä¸šåŠ¡é€»è¾‘
   â””â”€ LlmConfigDomainService.java      # é…ç½®ç®¡ç†ä¸šåŠ¡é€»è¾‘
```

**èŒè´£ï¼š**
- å®ç°æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- ä¸ç›´æ¥å®ç° API æ¥å£ï¼ˆä¿æŒæŠ€æœ¯æ— å…³æ€§ï¼‰
- å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è±¡

#### **trigger æ¨¡å—**ï¼ˆé€‚é…å™¨å±‚ï¼‰

HTTP é€‚é…å™¨ï¼Œå®ç° API æ¥å£ï¼Œå°† HTTP è¯·æ±‚è½¬æ¢ä¸ºé¢†åŸŸæœåŠ¡è°ƒç”¨ã€‚

```
trigger/
â”œâ”€ advice/                            # æ§åˆ¶å™¨å¢å¼º
â”‚  â””â”€ GlobalExceptionHandler.java    # å…¨å±€å¼‚å¸¸å¤„ç†
â”œâ”€ aop/                               # AOP åˆ‡é¢
â”‚  â””â”€ ApiLogAspect.java               # API æ—¥å¿—åˆ‡é¢
â””â”€ http/                              # HTTP æ§åˆ¶å™¨
   â”œâ”€ AiController.java               # AI å¯¹è¯æ§åˆ¶å™¨ (å®ç° IAiService)
   â”œâ”€ RAGController.java              # RAG çŸ¥è¯†åº“æ§åˆ¶å™¨ (å®ç° IRAGService)
   â””â”€ LlmConfigController.java        # é…ç½®ç®¡ç†æ§åˆ¶å™¨ (å®ç° ILlmConfigService)
```

**èŒè´£ï¼š**
- å®ç° API æ¥å£
- å¤„ç† HTTP è¯·æ±‚/å“åº”
- è°ƒç”¨é¢†åŸŸæœåŠ¡
- å¼‚å¸¸å¤„ç†ä¸æ—¥å¿—

### 2.3 æ¶æ„ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æŠ€æœ¯æ— å…³** | ä¸šåŠ¡é€»è¾‘ä¸ä¾èµ– HTTP æ¡†æ¶ï¼Œå¯æ›¿æ¢ä¸º gRPCã€æ¶ˆæ¯é˜Ÿåˆ— |
| **æ˜“äºæµ‹è¯•** | é¢†åŸŸæœåŠ¡ç‹¬ç«‹ï¼Œå¯å•ç‹¬å•å…ƒæµ‹è¯• |
| **èŒè´£æ¸…æ™°** | æ¯å±‚æœ‰æ˜ç¡®çš„èŒè´£ï¼Œä»£ç æ˜“ç»´æŠ¤ |
| **æ˜“äºæ‰©å±•** | æ–°å¢åŠŸèƒ½åªéœ€åœ¨å¯¹åº”å±‚æ·»åŠ ä»£ç  |
| **ç¬¦åˆ SOLID** | éµå¾ªå•ä¸€èŒè´£ã€ä¾èµ–å€’ç½®ç­‰åŸåˆ™ |

---

## 3. æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 3.1 åŠŸèƒ½æ¨¡å—

```
AI RAG çŸ¥è¯†åº“ç³»ç»Ÿ
â”œâ”€ å¤§æ¨¡å‹é…ç½®ç®¡ç†
â”‚  â”œâ”€ æ·»åŠ é…ç½®ï¼ˆOpenAIã€Ollamaã€Claudeï¼‰
â”‚  â”œâ”€ æµ‹è¯•è¿æ¥
â”‚  â”œâ”€ æ¿€æ´»/åˆ‡æ¢é…ç½® â­
â”‚  â”œâ”€ æ›´æ–°é…ç½®
â”‚  â””â”€ åˆ é™¤é…ç½®
â”œâ”€ çŸ¥è¯†åº“ç®¡ç†
â”‚  â”œâ”€ ä¸Šä¼ æ–‡æ¡£ï¼ˆPDFã€Wordã€TXTï¼‰
â”‚  â”œâ”€ Git ä»“åº“åˆ†æ
â”‚  â”œâ”€ æŸ¥è¯¢çŸ¥è¯†åº“åˆ—è¡¨
â”‚  â””â”€ åˆ é™¤çŸ¥è¯†åº“
â””â”€ AI å¯¹è¯
   â”œâ”€ åŒæ­¥å¯¹è¯
   â”œâ”€ æµå¼å¯¹è¯ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
   â””â”€ RAG å¢å¼ºå¯¹è¯ â­
```

### 3.2 å…³é”®åŠŸèƒ½æµç¨‹

#### åŠŸèƒ½ 1ï¼šæ·»åŠ å¤§æ¨¡å‹é…ç½®

```
ç”¨æˆ·å¡«å†™è¡¨å•
  â†’ POST /api/v1/llm/configs
  â†’ LlmConfigController.createConfig()
  â†’ LlmConfigDomainService.createConfig()
  â†’ ç”Ÿæˆ UUID
  â†’ å­˜å‚¨åˆ° Redis (llm:provider:configs)
  â†’ è¿”å›æˆåŠŸ
```

**Redis æ•°æ®ç»“æ„ï¼š**
```json
// Hash: llm:provider:configs
{
  "uuid-123": {
    "id": "uuid-123",
    "name": "OpenAI å®˜æ–¹",
    "providerType": "OPENAI",
    "baseUrl": "https://api.openai.com/v1",
    "apiKey": "sk-xxx",
    "defaultModel": "gpt-4o",
    "active": false
  }
}
```

#### åŠŸèƒ½ 2ï¼šæ¿€æ´»é…ç½®ï¼ˆåˆ‡æ¢å¤§æ¨¡å‹ï¼‰â­

```
ç”¨æˆ·ç‚¹å‡»"æ¿€æ´»"æŒ‰é’®
  â†’ POST /api/v1/llm/configs/{id}/activate
  â†’ LlmConfigController.activateConfig()
  â†’ LlmConfigDomainService.activateConfig()
  â†’ æ›´æ–° Redis (llm:provider:active = "uuid-123")
  â†’ è°ƒç”¨ DynamicChatClientFactory.onConfigActivated()
  â†’ é¢„çƒ­å®¢æˆ·ç«¯ç¼“å­˜ â­
  â†’ è¿”å›æˆåŠŸ
```

**å…³é”®ç‚¹ï¼š**
- æ›´æ–° Redis ä¸­çš„æ¿€æ´»é…ç½® ID
- è§¦å‘å·¥å‚ç±»é¢„çƒ­æ–°å®¢æˆ·ç«¯
- ä¸‹æ¬¡è°ƒç”¨ç›´æ¥ä½¿ç”¨æ–°çš„å¤§æ¨¡å‹

#### åŠŸèƒ½ 3ï¼šRAG å¢å¼ºå¯¹è¯ â­

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†’ GET /api/v1/ai/generate_stream_rag?model=gpt-4o&ragTag=java&message=ä»€ä¹ˆæ˜¯Springï¼Ÿ
  â†’ AiController.generateStreamRag()
  â†’ AiDomainService.generateStreamRag()
  â†’ æ­¥éª¤ 1: ä» pgvector æ£€ç´¢ç›¸å…³æ–‡æ¡£
  â†’ æ­¥éª¤ 2: æ„å»ºå¢å¼ºæç¤ºè¯ (System Prompt + æ£€ç´¢å†…å®¹ + ç”¨æˆ·é—®é¢˜)
  â†’ æ­¥éª¤ 3: è·å–æ¿€æ´»çš„ ChatClient
  â†’ æ­¥éª¤ 4: æµå¼è°ƒç”¨å¤§æ¨¡å‹
  â†’ æ­¥éª¤ 5: è¿”å› SSE æµ
```

**RAG æç¤ºè¯æ¨¡æ¿ï¼š**
```
System: ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹å‚è€ƒèµ„æ–™å›ç­”ç”¨æˆ·é—®é¢˜ã€‚

[å‚è€ƒèµ„æ–™]
æ–‡æ¡£1: Spring æ˜¯ä¸€ä¸ªå¼€æºçš„ Java åº”ç”¨æ¡†æ¶...
æ–‡æ¡£2: Spring Boot ç®€åŒ–äº† Spring åº”ç”¨çš„é…ç½®...

[ç”¨æˆ·é—®é¢˜]
ä»€ä¹ˆæ˜¯ Springï¼Ÿ
```

---

## 4. åŠ¨æ€åˆ‡æ¢å¤§æ¨¡å‹åŸç†

### 4.1 æ ¸å¿ƒç±»ï¼šDynamicChatClientFactory

è¿™æ˜¯æ•´ä¸ªåŠ¨æ€åˆ‡æ¢æœºåˆ¶çš„æ ¸å¿ƒï¼Œä½äº `app/factory/DynamicChatClientFactory.java`ã€‚

#### è®¾è®¡æ¨¡å¼

1. **å·¥å‚æ¨¡å¼** - æ ¹æ®é…ç½®åŠ¨æ€åˆ›å»ºä¸åŒç±»å‹çš„å®¢æˆ·ç«¯
2. **é€‚é…å™¨æ¨¡å¼** - ChatClientWrapper ç»Ÿä¸€ä¸åŒå®¢æˆ·ç«¯çš„æ¥å£
3. **å•ä¾‹æ¨¡å¼** - æ¯ä¸ªé…ç½®åªåˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯å®ä¾‹å¹¶ç¼“å­˜

#### å…³é”®æ•°æ®ç»“æ„

```java
// 1. å®¢æˆ·ç«¯ç¼“å­˜ï¼ˆKey: é…ç½®ID, Value: ChatClientåŒ…è£…å™¨ï¼‰
private final ConcurrentHashMap<String, ChatClientWrapper> clientCache = new ConcurrentHashMap<>();

// 2. è¯»å†™é”ï¼ˆä¿è¯å¹¶å‘å®‰å…¨ï¼‰
private final ReentrantReadWriteLock rwLock = new ReentrantReadWriteLock();

// 3. å½“å‰æ¿€æ´»çš„é…ç½® IDï¼ˆvolatile ä¿è¯å¯è§æ€§ï¼‰
private volatile String activeConfigId;
```

### 4.2 åˆ‡æ¢æµç¨‹è¯¦è§£

#### æ­¥éª¤ 1ï¼šç”¨æˆ·ç‚¹å‡»"æ¿€æ´»"æŒ‰é’®

```
å‰ç«¯ â†’ POST /api/v1/llm/configs/{id}/activate
```

#### æ­¥éª¤ 2ï¼šController æ¥æ”¶è¯·æ±‚

```java
@PostMapping("configs/{id}/activate")
public Response<Boolean> activateConfig(@PathVariable("id") String id) {
    return llmConfigDomainService.activateConfig(id);
}
```

#### æ­¥éª¤ 3ï¼šé¢†åŸŸæœåŠ¡æ›´æ–° Redis

```java
public Response<Boolean> activateConfig(String id) {
    // 1. æ›´æ–° Redis ä¸­çš„æ¿€æ´»é…ç½® ID
    RBucket<String> activeBucket = redissonClient.getBucket(ACTIVE_CONFIG_KEY);
    activeBucket.set(id); // llm:provider:active = "uuid-123"

    // 2. é€šçŸ¥å·¥å‚æ›´æ–°æ¿€æ´»é…ç½®
    dynamicChatClientFactory.onConfigActivated(id);

    return Response.success(true);
}
```

#### æ­¥éª¤ 4ï¼šå·¥å‚ç±»é¢„çƒ­æ–°å®¢æˆ·ç«¯ â­

```java
public void onConfigActivated(String newConfigId) {
    rwLock.writeLock().lock(); // åŠ å†™é”ï¼ˆç‹¬å ï¼‰
    try {
        // æ›´æ–°å†…å­˜ä¸­çš„æ¿€æ´»é…ç½® ID
        this.activeConfigId = newConfigId;

        // å¦‚æœæ–°é…ç½®çš„å®¢æˆ·ç«¯ä¸åœ¨ç¼“å­˜ä¸­ï¼Œæå‰åˆ›å»º
        if (!clientCache.containsKey(newConfigId)) {
            LlmProviderConfigDTO config = getConfigById(newConfigId);
            if (config != null) {
                // æ ¹æ®é…ç½®åˆ›å»ºå®¢æˆ·ç«¯å¹¶æ”¾å…¥ç¼“å­˜
                clientCache.put(newConfigId, createChatClient(config));
                log.info("é¢„çƒ­ ChatClient ç¼“å­˜: {}", config.getName());
            }
        }
    } finally {
        rwLock.writeLock().unlock(); // é‡Šæ”¾å†™é”
    }
}
```

#### æ­¥éª¤ 5ï¼šä¸‹æ¬¡è°ƒç”¨ä½¿ç”¨æ–°å®¢æˆ·ç«¯

```java
public ChatClientWrapper getActiveChatClient() {
    rwLock.readLock().lock(); // åŠ è¯»é”ï¼ˆå…è®¸å¹¶å‘ï¼‰
    try {
        String configId = getActiveConfigId(); // ä»å†…å­˜æˆ– Redis è·å–æ¿€æ´»çš„é…ç½® ID

        // ä»ç¼“å­˜è·å–å®¢æˆ·ç«¯ï¼ˆå·²é¢„çƒ­ï¼Œç›´æ¥è¿”å›ï¼‰
        return clientCache.computeIfAbsent(configId, id -> {
            // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œåˆ›å»ºæ–°å®¢æˆ·ç«¯
            LlmProviderConfigDTO config = getConfigById(id);
            return createChatClient(config);
        });
    } finally {
        rwLock.readLock().unlock(); // é‡Šæ”¾è¯»é”
    }
}
```

### 4.3 å¹¶å‘å®‰å…¨è®¾è®¡

#### ä¸ºä»€ä¹ˆéœ€è¦è¯»å†™é”ï¼Ÿ

è™½ç„¶ `ConcurrentHashMap` å·²ç»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†ä»¥ä¸‹åœºæ™¯éœ€è¦é¢å¤–ä¿æŠ¤ï¼š

```
åœºæ™¯ 1ï¼šåˆ‡æ¢é…ç½®æ—¶çš„åŸå­æ€§
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹ A      â”‚ æ›´æ–° activeConfigId + é¢„çƒ­ç¼“å­˜ï¼ˆå¿…é¡»åŸå­å®Œæˆï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
  å†™é”ï¼ˆç‹¬å ï¼‰

åœºæ™¯ 2ï¼šè¯»å–æ¿€æ´»é…ç½® + è·å–å®¢æˆ·ç«¯
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ çº¿ç¨‹ B      â”‚ è¯»å– activeConfigId + ä»ç¼“å­˜è·å–å®¢æˆ·ç«¯
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
  è¯»é”ï¼ˆå…è®¸å¹¶å‘ï¼‰
```

#### ä¸ºä»€ä¹ˆä½¿ç”¨ volatileï¼Ÿ

```java
private volatile String activeConfigId;
```

1. **å¯è§æ€§** - çº¿ç¨‹ A ä¿®æ”¹åï¼Œçº¿ç¨‹ B ç«‹å³çœ‹åˆ°æ–°å€¼
2. **ç¦æ­¢æŒ‡ä»¤é‡æ’åº** - ç¡®ä¿èµ‹å€¼æ“ä½œçš„é¡ºåºæ€§
3. **è½»é‡çº§åŒæ­¥** - æ¯” synchronized æ€§èƒ½æ›´å¥½

### 4.4 å®¢æˆ·ç«¯åˆ›å»ºæµç¨‹

```
createChatClient(config)
     â†“
æ ¹æ® providerType åˆ¤æ–­
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OPENAI    â”‚  ANTHROPIC  â”‚   OLLAMA   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“              â†“              â†“
createOpenAiWrapper()      createOllamaWrapper()
     â†“              â†“              â†“
OpenAiApi         OpenAiApi      OllamaApi
     â†“              â†“              â†“
OpenAiChatClient  OpenAiChatClient  OllamaChatClient
     â†“              â†“              â†“
è¿”å› ChatClientWrapperï¼ˆé€‚é…å™¨æ¨¡å¼ï¼‰
```

**ä»£ç ç¤ºä¾‹ï¼š**
```java
private ChatClientWrapper createOpenAiWrapper(LlmProviderConfigDTO config) {
    OpenAiApi api = new OpenAiApi(config.getBaseUrl(), config.getApiKey());
    OpenAiChatClient client = new OpenAiChatClient(api);

    // è¿”å›åŒ¿åå†…éƒ¨ç±»å®ç°çš„åŒ…è£…å™¨
    return new ChatClientWrapper() {
        @Override
        public ChatResponse call(Prompt prompt) {
            return client.call(prompt);
        }
        @Override
        public Flux<ChatResponse> stream(Prompt prompt) {
            return client.stream(prompt);
        }
    };
}
```

---

## 5. RAG å·¥ä½œæµç¨‹

### 5.1 ä»€ä¹ˆæ˜¯ RAGï¼Ÿ

**RAGï¼ˆRetrieval-Augmented Generationï¼‰** = æ£€ç´¢å¢å¼ºç”Ÿæˆ

```
ä¼ ç»Ÿå¯¹è¯ï¼šç”¨æˆ·é—®é¢˜ â†’ å¤§æ¨¡å‹ â†’ å›ç­”ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰

RAG å¯¹è¯ï¼šç”¨æˆ·é—®é¢˜ â†’ æ£€ç´¢çŸ¥è¯†åº“ â†’ æ„å»ºå¢å¼ºæç¤ºè¯ â†’ å¤§æ¨¡å‹ â†’ ç²¾å‡†å›ç­”
```

### 5.2 RAG å®Œæ•´æµç¨‹

#### é˜¶æ®µ 1ï¼šæ–‡æ¡£ä¸Šä¼ ä¸å‘é‡åŒ–

```
ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£ (example.pdf)
  â†“
POST /api/v1/rag/file/upload?ragTag=java
  â†“
RAGController.uploadFile()
  â†“
RAGDomainService.uploadFile()
  â†“
æ­¥éª¤ 1: TikaDocumentReader è§£ææ–‡æ¡£
  â†’ æå–æ–‡æœ¬å†…å®¹
  â†“
æ­¥éª¤ 2: TokenTextSplitter åˆ†å‰²æ–‡æœ¬
  â†’ æ¯å— 800 tokensï¼Œé‡å  400 tokens
  â†“
æ­¥éª¤ 3: ä¸ºæ¯ä¸ªæ–‡æœ¬å—æ·»åŠ å…ƒæ•°æ®
  â†’ metadata: { ragTag: "java", fileName: "example.pdf" }
  â†“
æ­¥éª¤ 4: EmbeddingClient ç”Ÿæˆå‘é‡
  â†’ æ–‡æœ¬ â†’ å‘é‡ (1536 ç»´)
  â†“
æ­¥éª¤ 5: PgVectorStore å­˜å‚¨åˆ° PostgreSQL
  â†’ å­˜å‚¨åœ¨ vector_store è¡¨
```

**æ•°æ®åº“è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE vector_store (
    id UUID PRIMARY KEY,
    content TEXT,                  -- æ–‡æœ¬å†…å®¹
    metadata JSONB,                -- å…ƒæ•°æ® {"ragTag": "java"}
    embedding VECTOR(1536)         -- å‘é‡ï¼ˆpgvector ç±»å‹ï¼‰
);

-- åˆ›å»ºå‘é‡ç´¢å¼•ï¼ˆåŠ é€Ÿç›¸ä¼¼åº¦æœç´¢ï¼‰
CREATE INDEX ON vector_store USING ivfflat (embedding vector_cosine_ops);
```

#### é˜¶æ®µ 2ï¼šRAG å¯¹è¯

```
ç”¨æˆ·æé—®ï¼šä»€ä¹ˆæ˜¯ Springï¼Ÿ
  â†“
GET /api/v1/ai/generate_stream_rag?model=gpt-4o&ragTag=java&message=ä»€ä¹ˆæ˜¯Springï¼Ÿ
  â†“
AiController.generateStreamRag()
  â†“
AiDomainService.generateStreamRag()
  â†“
æ­¥éª¤ 1: å°†ç”¨æˆ·é—®é¢˜å‘é‡åŒ–
  â†’ "ä»€ä¹ˆæ˜¯Springï¼Ÿ" â†’ å‘é‡ (1536 ç»´)
  â†“
æ­¥éª¤ 2: ä» pgvector æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£ (Top-K)
  â†’ SELECT content FROM vector_store
    WHERE metadata->>'ragTag' = 'java'
    ORDER BY embedding <-> query_vector
    LIMIT 5
  â†“
æ­¥éª¤ 3: æ„å»ºå¢å¼ºæç¤ºè¯
  â†’ System Prompt + æ£€ç´¢åˆ°çš„æ–‡æ¡£ + ç”¨æˆ·é—®é¢˜
  â†“
æ­¥éª¤ 4: è°ƒç”¨å¤§æ¨¡å‹
  â†’ client.stream(prompt)
  â†“
æ­¥éª¤ 5: è¿”å›æµå¼å“åº”ï¼ˆSSEï¼‰
  â†’ å‰ç«¯é€å­—æ˜¾ç¤º
```

### 5.3 RAG æ ¸å¿ƒä»£ç 

```java
public Flux<ChatResponse> generateStreamRag(String model, String ragTag, String message) {
    // æ­¥éª¤ 1: æ„å»ºæ£€ç´¢è¯·æ±‚
    SearchRequest searchRequest = SearchRequest.defaults()
        .withQuery(message)                    // ç”¨æˆ·é—®é¢˜
        .withTopK(5)                           // è¿”å› Top 5 ç›¸ä¼¼æ–‡æ¡£
        .withSimilarityThreshold(0.7)          // ç›¸ä¼¼åº¦é˜ˆå€¼
        .withFilterExpression(String.format("ragTag == '%s'", ragTag)); // è¿‡æ»¤æ¡ä»¶

    // æ­¥éª¤ 2: ä»å‘é‡æ•°æ®åº“æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£
    List<Document> similarDocuments = pgVectorStore.similaritySearch(searchRequest);

    // æ­¥éª¤ 3: æ„å»ºå¢å¼ºæç¤ºè¯
    String context = similarDocuments.stream()
        .map(Document::getContent)
        .collect(Collectors.joining("\n\n"));

    String systemPrompt = """
        ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ€æœ¯åŠ©æ‰‹ã€‚è¯·æ ¹æ®ä»¥ä¸‹å‚è€ƒèµ„æ–™å›ç­”ç”¨æˆ·é—®é¢˜ã€‚

        [å‚è€ƒèµ„æ–™]
        %s

        [ç”¨æˆ·é—®é¢˜]
        %s
        """.formatted(context, message);

    Message systemMessage = new SystemPromptTemplate(systemPrompt).createMessage();
    Message userMessage = new UserMessage(message);

    Prompt prompt = new Prompt(List.of(systemMessage, userMessage));

    // æ­¥éª¤ 4: æµå¼è°ƒç”¨å¤§æ¨¡å‹
    ChatClientWrapper client = dynamicChatClientFactory.getActiveChatClient();
    return client.stream(prompt);
}
```

---

## 6. ä»£ç æ‰§è¡Œæµç¨‹

### 6.1 æµå¼å¯¹è¯å®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (React/Vue)                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1. å‘èµ· SSE è¯·æ±‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GET /api/v1/ai/generate_stream_rag                             â”‚
â”‚  ?model=gpt-4o&ragTag=java&message=ä»€ä¹ˆæ˜¯Springï¼Ÿ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 2. è·¯ç”±åˆ° Controller
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AiController (å®ç° IAiService)                                 â”‚
â”‚  @GetMapping(value = "generate_stream_rag",                     â”‚
â”‚              produces = "text/event-stream")                    â”‚
â”‚  public Flux<ChatResponse> generateStreamRag(...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 3. è°ƒç”¨é¢†åŸŸæœåŠ¡
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AiDomainService.generateStreamRag()                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ­¥éª¤ 1: ä» pgvector æ£€ç´¢ç›¸ä¼¼æ–‡æ¡£ (Top-5)                    â”‚ â”‚
â”‚  â”‚   pgVectorStore.similaritySearch(searchRequest)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ­¥éª¤ 2: æ„å»ºå¢å¼ºæç¤ºè¯                                       â”‚ â”‚
â”‚  â”‚   System Prompt + æ£€ç´¢å†…å®¹ + ç”¨æˆ·é—®é¢˜                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ­¥éª¤ 3: è·å–æ¿€æ´»çš„ ChatClient                                â”‚ â”‚
â”‚  â”‚   ChatClientWrapper client =                              â”‚ â”‚
â”‚  â”‚       dynamicChatClientFactory.getActiveChatClient()      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ­¥éª¤ 4: æµå¼è°ƒç”¨å¤§æ¨¡å‹                                       â”‚ â”‚
â”‚  â”‚   return client.stream(prompt)                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 4. è·å– ChatClient
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DynamicChatClientFactory.getActiveChatClient()                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ rwLock.readLock().lock()  // åŠ è¯»é”                        â”‚ â”‚
â”‚  â”‚ String configId = getActiveConfigId()  // ä»å†…å­˜/Redisè·å–  â”‚ â”‚
â”‚  â”‚ return clientCache.computeIfAbsent(configId, id -> {      â”‚ â”‚
â”‚  â”‚     LlmProviderConfigDTO config = getConfigById(id);      â”‚ â”‚
â”‚  â”‚     return createChatClient(config);  // åˆ›å»ºæˆ–å¤ç”¨å®¢æˆ·ç«¯   â”‚ â”‚
â”‚  â”‚ });                                                        â”‚ â”‚
â”‚  â”‚ rwLock.readLock().unlock()  // é‡Šæ”¾è¯»é”                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 5. è°ƒç”¨å¤§æ¨¡å‹ API
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatClientWrapper.stream(prompt)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ OpenAiChatClient / OllamaChatClient                        â”‚ â”‚
â”‚  â”‚ â†“                                                          â”‚ â”‚
â”‚  â”‚ HTTP POST https://api.openai.com/v1/chat/completions      â”‚ â”‚
â”‚  â”‚ {                                                          â”‚ â”‚
â”‚  â”‚   "model": "gpt-4o",                                       â”‚ â”‚
â”‚  â”‚   "messages": [...],                                       â”‚ â”‚
â”‚  â”‚   "stream": true                                           â”‚ â”‚
â”‚  â”‚ }                                                          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 6. è¿”å› Flux<ChatResponse> (Reactive Stream)
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯æ¥æ”¶ SSE æµ                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ data: {"content": "Spring"}                                â”‚ â”‚
â”‚  â”‚ data: {"content": " æ˜¯ä¸€ä¸ª"}                                â”‚ â”‚
â”‚  â”‚ data: {"content": "å¼€æºçš„"}                                 â”‚ â”‚
â”‚  â”‚ ...                                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  é€å­—æ˜¾ç¤ºï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. å…³é”®æŠ€æœ¯ç‚¹

### 7.1 Spring AI æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ä½œç”¨ | ç¤ºä¾‹ |
|------|------|------|
| **ChatClient** | ä¸å¤§æ¨¡å‹äº¤äº’ | `OpenAiChatClient`, `OllamaChatClient` |
| **EmbeddingClient** | æ–‡æœ¬å‘é‡åŒ– | `OpenAiEmbeddingClient` |
| **DocumentReader** | æ–‡æ¡£è§£æ | `TikaDocumentReader` |
| **TextSplitter** | æ–‡æœ¬åˆ†å‰² | `TokenTextSplitter` |
| **VectorStore** | å‘é‡å­˜å‚¨ | `PgVectorStore` |

### 7.2 Reactive Streams (Flux)

```java
// Flux æ˜¯ Reactor æ¡†æ¶çš„æ ¸å¿ƒç±»ï¼Œè¡¨ç¤º 0-N ä¸ªå…ƒç´ çš„å¼‚æ­¥åºåˆ—
Flux<ChatResponse> stream = client.stream(prompt);

// è®¢é˜…æµï¼ˆSpring WebFlux è‡ªåŠ¨å¤„ç†ï¼‰
stream.subscribe(
    response -> System.out.println(response.getResult().getOutput().getContent()),
    error -> System.err.println("Error: " + error),
    () -> System.out.println("Complete")
);
```

**ä¸ºä»€ä¹ˆä½¿ç”¨ Fluxï¼Ÿ**
1. **éé˜»å¡** - ä¸å ç”¨çº¿ç¨‹ç­‰å¾…å“åº”
2. **èƒŒå‹æ”¯æŒ** - æ¶ˆè´¹è€…å¯ä»¥æ§åˆ¶ç”Ÿäº§é€Ÿåº¦
3. **å¤©ç„¶æ”¯æŒ SSE** - Spring WebFlux è‡ªåŠ¨è½¬æ¢ä¸º SSE æµ

### 7.3 pgvector å‘é‡ç›¸ä¼¼åº¦æœç´¢

```sql
-- ä½™å¼¦ç›¸ä¼¼åº¦æœç´¢ï¼ˆæœ€å¸¸ç”¨ï¼‰
SELECT content, 1 - (embedding <=> query_vector) AS similarity
FROM vector_store
WHERE metadata->>'ragTag' = 'java'
ORDER BY embedding <=> query_vector
LIMIT 5;

-- è¿ç®—ç¬¦è¯´æ˜
-- <=> : ä½™å¼¦è·ç¦»ï¼ˆ0 è¡¨ç¤ºå®Œå…¨ç›¸åŒï¼Œ2 è¡¨ç¤ºå®Œå…¨ç›¸åï¼‰
-- <-> : æ¬§å‡ é‡Œå¾—è·ç¦»
-- <#> : å†…ç§¯è·ç¦»
```

### 7.4 å¹¶å‘æ§åˆ¶

#### ConcurrentHashMap vs ReadWriteLock

```java
// ConcurrentHashMap: é€‚åˆç®€å•çš„ put/get æ“ä½œ
clientCache.put(id, client);
ChatClientWrapper client = clientCache.get(id);

// ReadWriteLock: é€‚åˆå¤æ‚çš„å¤åˆæ“ä½œ
rwLock.readLock().lock();
try {
    String id = getActiveConfigId();      // æ“ä½œ 1
    return clientCache.get(id);           // æ“ä½œ 2
} finally {
    rwLock.readLock().unlock();
}
```

**ä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ** ä¿è¯"è·å– ID + è·å–å®¢æˆ·ç«¯"ä¸¤æ­¥æ˜¯åŸå­æ“ä½œã€‚

---

## 8. æ•°æ®åº“è®¾è®¡

### 8.1 PostgreSQL (pgvector)

```sql
-- å‘é‡å­˜å‚¨è¡¨
CREATE TABLE vector_store (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    content TEXT NOT NULL,                     -- æ–‡æœ¬å†…å®¹
    metadata JSONB NOT NULL,                   -- å…ƒæ•°æ®ï¼ˆåŒ…å« ragTagï¼‰
    embedding VECTOR(1536) NOT NULL,           -- å‘é‡ï¼ˆOpenAI embedding ç»´åº¦ä¸º 1536ï¼‰
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å‘é‡ç´¢å¼•ï¼ˆIVFFLAT ç®—æ³•ï¼‰
CREATE INDEX vector_store_embedding_idx
ON vector_store
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- JSONB ç´¢å¼•ï¼ˆåŠ é€Ÿå…ƒæ•°æ®æŸ¥è¯¢ï¼‰
CREATE INDEX vector_store_metadata_idx
ON vector_store
USING gin (metadata);
```

### 8.2 Redis

```
# é…ç½®å­˜å‚¨
llm:provider:configs (Hash)
  â”œâ”€ uuid-1: { name: "OpenAI", providerType: "OPENAI", ... }
  â”œâ”€ uuid-2: { name: "Ollama", providerType: "OLLAMA", ... }
  â””â”€ ...

# æ¿€æ´»é…ç½®
llm:provider:active (String)
  â””â”€ "uuid-1"

# ä»»åŠ¡è¿›åº¦ï¼ˆGit ä»“åº“åˆ†æï¼‰
llm:task:progress:{taskId} (Hash)
  â”œâ”€ percentage: 50
  â”œâ”€ statusDescription: "æ­£åœ¨è§£æ RAGController.java"
  â”œâ”€ state: "PROCESSING"
  â””â”€ errorMessage: null
```

---

## 9. API æ¥å£è¯´æ˜

### 9.1 å¤§æ¨¡å‹é…ç½®ç®¡ç†

#### 1. è·å–æ‰€æœ‰é…ç½®
```http
GET /api/v1/llm/configs
Response: {
  "code": "0000",
  "info": "æŸ¥è¯¢æˆåŠŸ",
  "data": [
    {
      "id": "uuid-1",
      "name": "OpenAI å®˜æ–¹",
      "providerType": "OPENAI",
      "baseUrl": "https://api.openai.com/v1",
      "apiKey": "sk-xxx",
      "defaultModel": "gpt-4o",
      "active": true
    }
  ]
}
```

#### 2. æ–°å¢é…ç½®
```http
POST /api/v1/llm/configs
Content-Type: application/json

{
  "name": "Ollama æœ¬åœ°",
  "providerType": "OLLAMA",
  "baseUrl": "http://localhost:11434",
  "defaultModel": "qwen2.5:14b"
}
```

#### 3. æ¿€æ´»é…ç½®ï¼ˆåˆ‡æ¢å¤§æ¨¡å‹ï¼‰â­
```http
POST /api/v1/llm/configs/{id}/activate
Response: {
  "code": "0000",
  "info": "æ¿€æ´»æˆåŠŸ",
  "data": true
}
```

### 9.2 çŸ¥è¯†åº“ç®¡ç†

#### 1. ä¸Šä¼ æ–‡æ¡£
```http
POST /api/v1/rag/file/upload?ragTag=java
Content-Type: multipart/form-data

file: example.pdf
```

#### 2. æŸ¥è¯¢çŸ¥è¯†åº“åˆ—è¡¨
```http
GET /api/v1/rag/query_rag_tag_list
Response: {
  "code": "0000",
  "info": "æŸ¥è¯¢æˆåŠŸ",
  "data": ["java", "spring", "python"]
}
```

### 9.3 AI å¯¹è¯

#### 1. åŒæ­¥å¯¹è¯
```http
GET /api/v1/ai/generate?model=gpt-4o&message=ä½ å¥½
```

#### 2. æµå¼å¯¹è¯ï¼ˆSSEï¼‰
```http
GET /api/v1/ai/generate_stream?model=gpt-4o&message=ä½ å¥½
Accept: text/event-stream
```

#### 3. RAG å¢å¼ºå¯¹è¯ï¼ˆSSEï¼‰â­
```http
GET /api/v1/ai/generate_stream_rag?model=gpt-4o&ragTag=java&message=ä»€ä¹ˆæ˜¯Springï¼Ÿ
Accept: text/event-stream
```

---

## 10. å¸¸è§é—®é¢˜

### 10.1 ä¸ºä»€ä¹ˆåˆ‡æ¢å¤§æ¨¡å‹ä¸éœ€è¦é‡å¯ï¼Ÿ

**åŸå› ï¼š**
1. é…ç½®å­˜å‚¨åœ¨ Redis ä¸­ï¼Œä¸åœ¨ä»£ç é‡Œ
2. `DynamicChatClientFactory` ä½¿ç”¨å·¥å‚æ¨¡å¼åŠ¨æ€åˆ›å»ºå®¢æˆ·ç«¯
3. `volatile` ä¿è¯é…ç½® ID çš„å¯è§æ€§
4. ç¼“å­˜æœºåˆ¶é¿å…é‡å¤åˆ›å»º

### 10.2 ä¸ºä»€ä¹ˆä½¿ç”¨ DDD æ¶æ„ï¼Ÿ

**ä¼˜åŠ¿ï¼š**
1. **ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹** - å¯ä»¥å•ç‹¬æµ‹è¯•ï¼Œä¸ä¾èµ– HTTP æ¡†æ¶
2. **æŠ€æœ¯å¯æ›¿æ¢** - è½»æ¾æ›¿æ¢ä¸º gRPCã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰
3. **èŒè´£æ¸…æ™°** - æ¯å±‚æœ‰æ˜ç¡®çš„èŒè´£
4. **æ˜“äºç»´æŠ¤** - ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ–°äººå®¹æ˜“ä¸Šæ‰‹

### 10.3 ä¸ºä»€ä¹ˆ RAG æ¯”ç›´æ¥é—®å¤§æ¨¡å‹å‡†ç¡®ï¼Ÿ

**RAG ä¼˜åŠ¿ï¼š**
1. **çŸ¥è¯†æ›´æ–°** - å¤§æ¨¡å‹è®­ç»ƒæ•°æ®æœ‰æ—¶é—´æˆªæ­¢ï¼ŒRAG å¯ä»¥å®æ—¶æ›´æ–°çŸ¥è¯†
2. **é¢†åŸŸä¸“ä¸šæ€§** - ä¸Šä¼ é¢†åŸŸæ–‡æ¡£åï¼Œå›ç­”æ›´ä¸“ä¸š
3. **å¯è§£é‡Šæ€§** - èƒ½çŸ¥é“ç­”æ¡ˆæ¥è‡ªå“ªäº›æ–‡æ¡£
4. **å‡å°‘å¹»è§‰** - åŸºäºçœŸå®æ–‡æ¡£ï¼Œè€Œä¸æ˜¯"ç¼–é€ "ç­”æ¡ˆ

### 10.4 å¦‚ä½•é€‰æ‹© Embedding æ¨¡å‹ï¼Ÿ

| æ¨¡å‹ | ç»´åº¦ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| **OpenAI text-embedding-3-small** | 1536 | å‡†ç¡®åº¦é«˜ï¼Œå¤šè¯­è¨€æ”¯æŒ | éœ€è¦ä»˜è´¹ |
| **OpenAI text-embedding-3-large** | 3072 | æœ€é«˜å‡†ç¡®åº¦ | æˆæœ¬æ›´é«˜ |
| **Ollama nomic-embed-text** | 768 | å…è´¹ï¼Œæœ¬åœ°éƒ¨ç½² | å‡†ç¡®åº¦ç¨ä½ |

**å»ºè®®ï¼š**
- ç”Ÿäº§ç¯å¢ƒï¼šOpenAI text-embedding-3-small
- æœ¬åœ°å¼€å‘/æµ‹è¯•ï¼šOllama nomic-embed-text

### 10.5 å¦‚ä½•ä¼˜åŒ– RAG æ•ˆæœï¼Ÿ

1. **æ–‡æ¡£åˆ†å‰²ç­–ç•¥** - è°ƒæ•´ `chunkSize` å’Œ `chunkOverlap`
2. **ç›¸ä¼¼åº¦é˜ˆå€¼** - è°ƒæ•´ `similarityThreshold`ï¼ˆ0.7 - 0.85ï¼‰
3. **æ£€ç´¢æ•°é‡** - è°ƒæ•´ `topK`ï¼ˆ3 - 10ï¼‰
4. **æç¤ºè¯ä¼˜åŒ–** - æ”¹è¿› System Prompt
5. **é‡æ’åº** - ä½¿ç”¨ Reranker æ¨¡å‹å¯¹æ£€ç´¢ç»“æœé‡æ–°æ’åº

---

## ğŸ“š å­¦ä¹ å»ºè®®

### åˆå­¦è€…ï¼ˆç¬¬ 1 å‘¨ï¼‰
1. âœ… é˜…è¯»æœ¬æ–‡æ¡£ï¼Œç†è§£æ•´ä½“æ¶æ„
2. âœ… è¿è¡Œé¡¹ç›®ï¼Œæµ‹è¯•å„é¡¹åŠŸèƒ½
3. âœ… é˜…è¯» `DynamicChatClientFactory.java` æºç 
4. âœ… è°ƒè¯•ä¸€æ¬¡å®Œæ•´çš„ RAG å¯¹è¯æµç¨‹

### è¿›é˜¶ï¼ˆç¬¬ 2 å‘¨ï¼‰
1. âœ… å­¦ä¹  Spring AI å®˜æ–¹æ–‡æ¡£
2. âœ… å®ç°ä¸€ä¸ªæ–°çš„æä¾›å•†ï¼ˆå¦‚ Azure OpenAIï¼‰
3. âœ… ä¼˜åŒ– RAG æ•ˆæœï¼ˆè°ƒå‚ï¼‰
4. âœ… æ·»åŠ å•å…ƒæµ‹è¯•

### é«˜çº§ï¼ˆç¬¬ 3 å‘¨ï¼‰
1. âœ… å®ç° Reranker é‡æ’åº
2. âœ… æ·»åŠ ä¼šè¯è®°å¿†ï¼ˆChat Historyï¼‰
3. âœ… å®ç°å¤šæ¨¡æ€ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ï¼‰
4. âœ… æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€å¼‚æ­¥ï¼‰

---

## ğŸ“– å‚è€ƒèµ„æ–™

- [Spring AI å®˜æ–¹æ–‡æ¡£](https://docs.spring.io/spring-ai/reference/)
- [pgvector æ–‡æ¡£](https://github.com/pgvector/pgvector)
- [Redisson æ–‡æ¡£](https://github.com/redisson/redisson)
- [DDD é¢†åŸŸé©±åŠ¨è®¾è®¡](https://www.domainlanguage.com/ddd/)

---

**ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼æœ‰ä»»ä½•é—®é¢˜æ¬¢è¿äº¤æµã€‚** ğŸš€
