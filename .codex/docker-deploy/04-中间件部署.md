# 03 - ä¸­é—´ä»¶éƒ¨ç½²

> æœ¬ç« ä»‹ç»å¦‚ä½•éƒ¨ç½²é¡¹ç›®æ‰€éœ€çš„ä¸‰ä¸ªæ ¸å¿ƒä¸­é—´ä»¶ï¼šPostgreSQL (pgvector)ã€Redis å’Œ Ollamaã€‚

---

## ğŸ“‹ æœ¬ç« ç›®æ ‡

å®Œæˆæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… éƒ¨ç½²å¸¦å‘é‡æ‰©å±•çš„ PostgreSQL æ•°æ®åº“
- âœ… éƒ¨ç½² Redis ç¼“å­˜æœåŠ¡
- âœ… éƒ¨ç½² Ollama å¹¶ä¸‹è½½ AI æ¨¡å‹
- âœ… éªŒè¯æ‰€æœ‰ä¸­é—´ä»¶æ­£å¸¸è¿è¡Œ

---

## ğŸŒ åˆ›å»º Docker ç½‘ç»œ

é¦–å…ˆï¼Œåˆ›å»ºé¡¹ç›®ä¸“ç”¨çš„ Docker ç½‘ç»œï¼Œè®©æ‰€æœ‰å®¹å™¨å¯ä»¥é€šè¿‡åç§°äº’ç›¸è®¿é—®ï¼š

```bash
# æ£€æŸ¥ç½‘ç»œæ˜¯å¦å·²å­˜åœ¨
docker network ls | grep binghe-network

# å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºç½‘ç»œ
docker network create binghe-network

# éªŒè¯åˆ›å»ºæˆåŠŸ
docker network inspect binghe-network
```

---

## ğŸ˜ PostgreSQL + pgvector

### ä»€ä¹ˆæ˜¯ pgvectorï¼Ÿ

[pgvector](https://github.com/pgvector/pgvector) æ˜¯ PostgreSQL çš„å‘é‡æ‰©å±•ï¼Œç”¨äºå­˜å‚¨å’Œæ£€ç´¢å‘é‡æ•°æ®ï¼Œæ˜¯ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰åº”ç”¨çš„æ ¸å¿ƒç»„ä»¶ã€‚

### éƒ¨ç½²æ­¥éª¤

#### 1. æ‹‰å–é•œåƒ

```bash
docker pull pgvector/pgvector:pg16
```

#### 2. å¯åŠ¨å®¹å™¨

```bash
docker run -d \
  --name vector_db \
  --network binghe-network \
  -p 5432:5432 \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e POSTGRES_DB=postgres \
  -e TZ=Asia/Shanghai \
  -v pgvector-data:/var/lib/postgresql/data \
  --restart unless-stopped \
  pgvector/pgvector:pg16
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | è¯´æ˜ |
|------|------|
| `--name vector_db` | å®¹å™¨åç§°ï¼Œå…¶ä»–å®¹å™¨é€šè¿‡æ­¤åç§°è®¿é—® |
| `--network binghe-network` | åŠ å…¥è‡ªå®šä¹‰ç½‘ç»œ |
| `-p 5432:5432` | ç«¯å£æ˜ å°„ï¼Œæ–¹ä¾¿æœ¬åœ°å·¥å…·è¿æ¥ |
| `-e POSTGRES_*` | æ•°æ®åº“é…ç½® |
| `-v pgvector-data:...` | æ•°æ®æŒä¹…åŒ– |
| `--restart unless-stopped` | è‡ªåŠ¨é‡å¯ç­–ç•¥ |

#### 3. åˆ›å»ºé¡¹ç›®æ•°æ®åº“

```bash
# åˆ›å»º ai-rag-knowledge æ•°æ®åº“
docker exec vector_db psql -U postgres -c \
  "CREATE DATABASE \"ai-rag-knowledge\";"

# å¯ç”¨ pgvector æ‰©å±•
docker exec vector_db psql -U postgres -d ai-rag-knowledge -c \
  "CREATE EXTENSION IF NOT EXISTS vector;"
```

#### 4. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep vector_db

# æµ‹è¯•è¿æ¥
docker exec vector_db psql -U postgres -d ai-rag-knowledge -c \
  "SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';"

# é¢„æœŸè¾“å‡ºï¼š
# extname | extversion
# --------+------------
# vector  | 0.7.x
```

### ä½¿ç”¨æ•°æ®åº“å®¢æˆ·ç«¯è¿æ¥

å¦‚æœéœ€è¦ä½¿ç”¨å¯è§†åŒ–å·¥å…·ï¼ˆå¦‚ DBeaverã€Navicatï¼‰è¿æ¥ï¼š

| é…ç½®é¡¹ | å€¼ |
|--------|-----|
| Host | localhost |
| Port | 5432 |
| Database | ai-rag-knowledge |
| Username | postgres |
| Password | postgres |

---

## ğŸ”´ Redis

### éƒ¨ç½²æ­¥éª¤

#### 1. æ‹‰å–é•œåƒ

```bash
docker pull redis:alpine3.21
```

#### 2. å¯åŠ¨å®¹å™¨

```bash
docker run -d \
  --name redis \
  --network binghe-network \
  -p 6379:6379 \
  -e TZ=Asia/Shanghai \
  -v redis-data:/data \
  --restart unless-stopped \
  redis:alpine3.21 \
  redis-server --appendonly yes
```

**å‚æ•°è¯´æ˜**ï¼š

| å‚æ•° | è¯´æ˜ |
|------|------|
| `redis:alpine3.21` | ä½¿ç”¨ Alpine åŸºç¡€é•œåƒï¼Œä½“ç§¯æ›´å° |
| `--appendonly yes` | å¯ç”¨ AOF æŒä¹…åŒ– |
| `-v redis-data:/data` | æ•°æ®æŒä¹…åŒ– |

#### 3. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep redis

# æµ‹è¯• Redis è¿æ¥
docker exec redis redis-cli ping
# é¢„æœŸè¾“å‡ºï¼šPONG

# æµ‹è¯•è¯»å†™
docker exec redis redis-cli set test "Hello Docker!"
docker exec redis redis-cli get test
# é¢„æœŸè¾“å‡ºï¼šHello Docker!
```

---

## ğŸ¤– Ollama

### ä»€ä¹ˆæ˜¯ Ollamaï¼Ÿ

[Ollama](https://ollama.ai/) æ˜¯ä¸€ä¸ªæœ¬åœ°è¿è¡Œå¤§è¯­è¨€æ¨¡å‹çš„å·¥å…·ï¼Œæ”¯æŒ Llamaã€Qwenã€DeepSeek ç­‰å¼€æºæ¨¡å‹ã€‚

### éƒ¨ç½²æ­¥éª¤

#### 1. æ‹‰å–é•œåƒ

```bash
docker pull ollama/ollama:0.5.10
```

#### 2. å¯åŠ¨å®¹å™¨

```bash
docker run -d \
  --name ollama \
  --network binghe-network \
  -p 11434:11434 \
  -e TZ=Asia/Shanghai \
  -v ollama-data:/root/.ollama \
  --restart unless-stopped \
  ollama/ollama:0.5.10
```

> âš ï¸ **æ³¨æ„**ï¼šå¦‚æœä½ çš„æœºå™¨æœ‰ GPUï¼ˆå¦‚ NVIDIAï¼‰ï¼Œå¯æ·»åŠ  GPU æ”¯æŒï¼š
> ```bash
> # NVIDIA GPU ç‰ˆæœ¬
> docker run -d \
>   --name ollama \
>   --gpus=all \
>   --network binghe-network \
>   -p 11434:11434 \
>   -v ollama-data:/root/.ollama \
>   --restart unless-stopped \
>   ollama/ollama:0.5.10
> ```

#### 3. ä¸‹è½½ AI æ¨¡å‹

Ollama éœ€è¦ä¸‹è½½æ¨¡å‹æ‰èƒ½ä½¿ç”¨ï¼Œä»¥ä¸‹æ˜¯å¸¸ç”¨æ¨¡å‹æ¨èï¼š

| æ¨¡å‹ | å¤§å° | æ¨èå†…å­˜ | ç”¨é€” |
|------|------|----------|------|
| `qwen2.5:0.5b` | ~400MB | 4GB | å¿«é€Ÿæµ‹è¯•ï¼Œè½»é‡ |
| `qwen2.5:1.5b` | ~1GB | 8GB | æ—¥å¸¸å¯¹è¯ |
| `qwen2.5:7b` | ~4.5GB | 16GB | é«˜è´¨é‡è¾“å‡º |
| `nomic-embed-text` | ~300MB | 4GB | **æ–‡æœ¬å‘é‡åŒ–ï¼ˆRAG å¿…éœ€ï¼‰** |

```bash
# ä¸‹è½½å¯¹è¯æ¨¡å‹ï¼ˆé€‰æ‹©ä¸€ä¸ªï¼‰
docker exec ollama ollama pull qwen2.5:0.5b

# ä¸‹è½½ Embedding æ¨¡å‹ï¼ˆRAG å¿…éœ€ï¼‰
docker exec ollama ollama pull nomic-embed-text

# æŸ¥çœ‹å·²ä¸‹è½½çš„æ¨¡å‹
docker exec ollama ollama list
```

> ğŸ’¡ **æç¤º**ï¼šæ¨¡å‹ä¸‹è½½å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œå–å†³äºç½‘ç»œé€Ÿåº¦ã€‚

#### 4. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep ollama

# æµ‹è¯• API å¯ç”¨æ€§
curl http://localhost:11434/api/version
# é¢„æœŸè¾“å‡ºï¼š{"version":"0.5.10"}

# æµ‹è¯•æ¨¡å‹å¯¹è¯ï¼ˆéœ€è¦å…ˆä¸‹è½½æ¨¡å‹ï¼‰
curl http://localhost:11434/api/generate -d '{
  "model": "qwen2.5:0.5b",
  "prompt": "ä½ å¥½",
  "stream": false
}'
```

#### 5. äº¤äº’å¼å¯¹è¯æµ‹è¯•

```bash
# è¿›å…¥ Ollama äº¤äº’æ¨¡å¼
docker exec -it ollama ollama run qwen2.5:0.5b

# è¾“å…¥é—®é¢˜è¿›è¡Œå¯¹è¯ï¼ŒæŒ‰ Ctrl+D é€€å‡º
```

---

## ğŸ“Š ä¸­é—´ä»¶çŠ¶æ€æ€»è§ˆ

éƒ¨ç½²å®Œæˆåï¼Œæ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€ï¼š

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿è¡Œä¸­çš„å®¹å™¨
docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
```

é¢„æœŸè¾“å‡ºï¼š

```
NAMES        IMAGE                     STATUS          PORTS
vector_db    pgvector/pgvector:pg16    Up X minutes    0.0.0.0:5432->5432/tcp
redis        redis:alpine3.21          Up X minutes    0.0.0.0:6379->6379/tcp
ollama       ollama/ollama:0.5.10      Up X minutes    0.0.0.0:11434->11434/tcp
```

æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼š

```bash
docker network inspect binghe-network --format \
  '{{range .Containers}}{{.Name}} {{end}}'
# é¢„æœŸè¾“å‡ºï¼švector_db redis ollama
```

---

## ğŸ“ ä¸€é”®éƒ¨ç½²è„šæœ¬ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ å¸Œæœ›å¿«é€Ÿéƒ¨ç½²æ‰€æœ‰ä¸­é—´ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹è„šæœ¬ï¼š

```bash
#!/bin/bash
# æ–‡ä»¶å: deploy-middleware.sh

set -e

echo "ğŸŒ åˆ›å»º Docker ç½‘ç»œ..."
docker network create binghe-network 2>/dev/null || echo "ç½‘ç»œå·²å­˜åœ¨"

echo "ğŸ˜ éƒ¨ç½² PostgreSQL..."
docker run -d --name vector_db \
  --network binghe-network \
  -p 5432:5432 \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -e TZ=Asia/Shanghai \
  -v pgvector-data:/var/lib/postgresql/data \
  --restart unless-stopped \
  pgvector/pgvector:pg16

echo "â³ ç­‰å¾… PostgreSQL å¯åŠ¨..."
sleep 5

echo "ğŸ“¦ åˆ›å»ºæ•°æ®åº“..."
docker exec vector_db psql -U postgres -c \
  "CREATE DATABASE \"ai-rag-knowledge\";" 2>/dev/null || echo "æ•°æ®åº“å·²å­˜åœ¨"
docker exec vector_db psql -U postgres -d ai-rag-knowledge -c \
  "CREATE EXTENSION IF NOT EXISTS vector;"

echo "ğŸ”´ éƒ¨ç½² Redis..."
docker run -d --name redis \
  --network binghe-network \
  -p 6379:6379 \
  -e TZ=Asia/Shanghai \
  -v redis-data:/data \
  --restart unless-stopped \
  redis:alpine3.21 redis-server --appendonly yes

echo "ğŸ¤– éƒ¨ç½² Ollama..."
docker run -d --name ollama \
  --network binghe-network \
  -p 11434:11434 \
  -e TZ=Asia/Shanghai \
  -v ollama-data:/root/.ollama \
  --restart unless-stopped \
  ollama/ollama:0.5.10

echo "âœ… ä¸­é—´ä»¶éƒ¨ç½²å®Œæˆï¼"
docker ps --format "table {{.Names}}\t{{.Status}}"
```

---

## âœ… æœ¬ç« æ£€æŸ¥æ¸…å•

åœ¨è¿›å…¥ä¸‹ä¸€ç« ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] `docker ps` æ˜¾ç¤ºä¸‰ä¸ªå®¹å™¨éƒ½åœ¨è¿è¡Œ
- [ ] PostgreSQL: `docker exec vector_db psql -U postgres -c "SELECT 1"` è¿”å›æˆåŠŸ
- [ ] Redis: `docker exec redis redis-cli ping` è¿”å› `PONG`
- [ ] Ollama: `curl http://localhost:11434/api/version` è¿”å›ç‰ˆæœ¬ä¿¡æ¯
- [ ] è‡³å°‘ä¸‹è½½äº†ä¸€ä¸ª Ollama æ¨¡å‹ç”¨äºæµ‹è¯•

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| ä¸Šä¸€ç¯‡ | ä¸‹ä¸€ç¯‡ |
|--------|--------|
| [03-AI åŸºç¡€çŸ¥è¯†](./03-AIåŸºç¡€çŸ¥è¯†.md) | [05-åº”ç”¨éƒ¨ç½²](./05-åº”ç”¨éƒ¨ç½².md) |

[è¿”å›ç›®å½•](./README.md)
