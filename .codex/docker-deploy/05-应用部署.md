# 05 - åº”ç”¨éƒ¨ç½²

> æœ¬ç« ä»‹ç»å¦‚ä½•æ„å»ºå’Œéƒ¨ç½² Spring Boot åç«¯åº”ç”¨ã€‚

---

## ğŸ“‹ æœ¬ç« ç›®æ ‡

å®Œæˆæœ¬ç« åï¼Œä½ å°†èƒ½å¤Ÿï¼š
- âœ… ä½¿ç”¨ Maven æ„å»ºé¡¹ç›® JAR åŒ…
- âœ… ç†è§£ Dockerfile çš„å·¥ä½œåŸç†
- âœ… æ„å»ºåº”ç”¨ Docker é•œåƒ
- âœ… ä½¿ç”¨ docker-compose å¯åŠ¨åº”ç”¨

---

## ğŸ”§ å‰ç½®æ¡ä»¶

åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

1. **å·²å®Œæˆä¸­é—´ä»¶éƒ¨ç½²**ï¼ˆPostgreSQLã€Redisã€Ollama è¿è¡Œä¸­ï¼‰
2. **å·²å®‰è£… JDK 17**
3. **å·²å®‰è£… Maven**

éªŒè¯ç¯å¢ƒï¼š

```bash
# æ£€æŸ¥ JDK ç‰ˆæœ¬
java -version
# é¢„æœŸï¼šopenjdk version "17.x.x"

# æ£€æŸ¥ Maven ç‰ˆæœ¬
mvn -version
# é¢„æœŸï¼šApache Maven 3.x.x

# ç¡®è®¤ä¸­é—´ä»¶è¿è¡Œä¸­
docker ps | grep -E "vector_db|redis|ollama"
```

---

## ğŸ“¦ æ„å»º JAR åŒ…

### 1. è¿›å…¥é¡¹ç›®ç›®å½•

```bash
cd /Users/xiexu/xiaofu/ai-rag-knowledge-study
```

### 2. æ‰§è¡Œ Maven æ„å»º

```bash
# æ¸…ç†å¹¶æ‰“åŒ…ï¼ˆè·³è¿‡æµ‹è¯•åŠ å¿«é€Ÿåº¦ï¼‰
mvn clean package -DskipTests

# å¦‚æœéœ€è¦è¿è¡Œæµ‹è¯•
mvn clean package
```

æ„å»ºæˆåŠŸåï¼ŒJAR æ–‡ä»¶ä½äºï¼š

```
xfg-dev-tech-app/target/ai-rag-knowledge-app-exec.jar
```

### 3. éªŒè¯ JAR åŒ…

```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh xfg-dev-tech-app/target/ai-rag-knowledge-app-exec.jar

# æŸ¥çœ‹ JAR åŒ…ä¿¡æ¯
unzip -l xfg-dev-tech-app/target/ai-rag-knowledge-app-exec.jar | head -20
```

---

## ğŸ³ ç†è§£ Dockerfile

> Dockerfile æ˜¯ä¸€ä¸ª"èœè°±"ï¼Œå‘Šè¯‰ Docker å¦‚ä½•ä¸€æ­¥ä¸€æ­¥åœ°æ„å»ºé•œåƒã€‚

é¡¹ç›®ä½¿ç”¨çš„ Dockerfile ä½äº `.claude/docker-deploy/Dockerfile`ï¼š

```dockerfile
# åŸºç¡€é•œåƒ (Eclipse Temurin JRE 17)
FROM eclipse-temurin:17-jre

# ç»´æŠ¤è€…ä¿¡æ¯
LABEL maintainer="xiexu"

# ç¯å¢ƒå˜é‡
ENV PARAMS=""
ENV JAVA_OPTS="-Xms512m -Xmx512m"
ENV TZ=Asia/Shanghai

# æ—¶åŒºé…ç½®
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone

# å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶ JAR åŒ…
COPY target/ai-rag-knowledge-app-exec.jar /app/ai-rag-knowledge-app.jar

# æš´éœ²ç«¯å£
EXPOSE 8090

# å¯åŠ¨å‘½ä»¤
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/ai-rag-knowledge-app.jar --spring.profiles.active=dev $PARAMS"]
```

---

### Dockerfile å‘½ä»¤é€è¡Œè¯¦è§£

#### 1ï¸âƒ£ FROM - é€‰æ‹©åŸºç¡€ç¯å¢ƒ

```dockerfile
FROM eclipse-temurin:17-jre
```

**ä½œç”¨**ï¼šé€‰æ‹©ä¸€ä¸ª"åŸºç¡€ç¯å¢ƒ"ï¼Œç›¸å½“äºé€‰æ‹©ä¸€å°é¢„è£…äº†è½¯ä»¶çš„ç”µè„‘ã€‚

```
æ‰“ä¸ªæ¯”æ–¹ï¼š

ä½ è¦åšä¸€é“èœï¼Œå¯ä»¥ï¼š
- ä»é›¶å¼€å§‹ï¼ˆä¹°é”…ã€åˆ€ã€ç §æ¿...ï¼‰â†’ å¤ªéº»çƒ¦
- ç”¨ç°æˆçš„å¨æˆ¿ï¼ˆå·²ç»æœ‰é”…ç¢—ç“¢ç›†ï¼‰â†’ ç›´æ¥åšèœ

FROM å°±æ˜¯é€‰æ‹©"ç°æˆçš„å¨æˆ¿"
eclipse-temurin:17-jre = ä¸€ä¸ªå·²ç»å®‰è£…å¥½ Java 17 çš„ Linux ç³»ç»Ÿ
```

**ä¸ºä»€ä¹ˆç”¨ JRE è€Œä¸æ˜¯ JDKï¼Ÿ**
- JDK = Java å¼€å‘å·¥å…·åŒ…ï¼ˆåŒ…å«ç¼–è¯‘å™¨ï¼Œä½“ç§¯å¤§ï¼‰
- JRE = Java è¿è¡Œç¯å¢ƒï¼ˆåªèƒ½è¿è¡Œï¼Œä½“ç§¯å°ï¼‰
- æˆ‘ä»¬åªéœ€è¦**è¿è¡Œ** JAR åŒ…ï¼Œä¸éœ€è¦ç¼–è¯‘ï¼Œæ‰€ä»¥ç”¨ JRE æ›´è½»é‡

---

#### 2ï¸âƒ£ LABEL - æ·»åŠ å…ƒæ•°æ®æ ‡ç­¾

```dockerfile
LABEL maintainer="xiexu"
```

**ä½œç”¨**ï¼šç»™é•œåƒæ·»åŠ **å…ƒæ•°æ®ä¿¡æ¯**ï¼Œè®°å½•è°è´Ÿè´£ç»´æŠ¤è¿™ä¸ªé•œåƒã€‚

```
æ‰“ä¸ªæ¯”æ–¹ï¼š

å°±åƒä½ å†™çš„ä»£ç æ–‡ä»¶é‡ŒåŠ ä¸Šæ³¨é‡Šï¼š
/**
 * @author xiexu
 */

è¿™ä¸ªæ³¨é‡Šä¸ä¼šå½±å“ä»£ç è¿è¡Œï¼Œä½†åˆ«äººçœ‹åˆ°å°±çŸ¥é“æ˜¯ä½ å†™çš„ã€‚
LABEL maintainer ä¹Ÿæ˜¯åŒæ ·çš„é“ç†â€”â€”ç»™é•œåƒã€Œç½²åã€ã€‚
```

**å¯¹é•œåƒè¿è¡Œæœ‰å½±å“å—ï¼Ÿ**
- âŒ å®Œå…¨æ²¡æœ‰å½±å“ï¼Œçº¯ç²¹æ˜¯ä¿¡æ¯è®°å½•
- âœ… æ–¹ä¾¿å…¶ä»–äººçŸ¥é“ã€Œè¿™ä¸ªé•œåƒæœ‰é—®é¢˜æ‰¾è°ã€

**å¦‚ä½•æŸ¥çœ‹æ ‡ç­¾ï¼Ÿ**

```bash
# æ„å»ºé•œåƒåï¼Œå¯ä»¥è¿™æ ·æŸ¥çœ‹
docker inspect ai-rag-knowledge-app:1.0 --format='{{.Config.Labels}}'
# è¾“å‡ºï¼šmap[maintainer:xiexu]
```

**å…¶ä»–å¸¸è§ LABEL ç”¨æ³•**ï¼š

```dockerfile
# å¯ä»¥æ·»åŠ å¤šä¸ªæ ‡ç­¾
LABEL maintainer="xiexu" \
      version="1.0" \
      description="AI RAG Knowledge Study Application"
```

> [!NOTE]
> **å†å²èƒŒæ™¯**ï¼šæ—©æœŸ Docker æœ‰ä¸€ä¸ªä¸“é—¨çš„ `MAINTAINER` æŒ‡ä»¤ï¼Œä½†å·²è¢«**åºŸå¼ƒ**ï¼Œç°åœ¨æ¨èç”¨ `LABEL maintainer=xxx` ä»£æ›¿ã€‚

---

#### 3ï¸âƒ£ ENV - è®¾ç½®ç¯å¢ƒå˜é‡

```dockerfile
ENV JAVA_OPTS="-Xms512m -Xmx512m"
ENV TZ=Asia/Shanghai
```

**ä½œç”¨**ï¼šå®šä¹‰å®¹å™¨å†…å¯ç”¨çš„å˜é‡ï¼Œç±»ä¼¼äºç»™å®¹å™¨"è®¾ç½®å‚æ•°"ã€‚

```
æ‰“ä¸ªæ¯”æ–¹ï¼š

ä½ ä¹°äº†ä¸€å°æ–°ç”µè„‘ï¼Œéœ€è¦è¿›è¡Œä¸€äº›è®¾ç½®ï¼š
- è®¾ç½®æ—¶åŒº = ENV TZ=Asia/Shanghai
- è®¾ç½®å†…å­˜åˆ†é… = ENV JAVA_OPTS="-Xms512m -Xmx512m"

è¿™äº›è®¾ç½®åœ¨å®¹å™¨å¯åŠ¨åä¼šä¸€ç›´ç”Ÿæ•ˆ
```

**JAVA_OPTS å‚æ•°è§£é‡Š**ï¼š
```
-Xms512m  = åˆå§‹åˆ†é… 512MB å†…å­˜ï¼ˆminimumï¼‰
-Xmx512m  = æœ€å¤§ä½¿ç”¨ 512MB å†…å­˜ï¼ˆmaximumï¼‰

å¦‚æœä½ çš„æœåŠ¡å™¨å†…å­˜å……è¶³ï¼Œå¯ä»¥è°ƒå¤§ï¼š
-Xms1g -Xmx1g  â†’ åˆ†é… 1GB å†…å­˜
```

---

#### 4ï¸âƒ£ WORKDIR - è®¾ç½®å·¥ä½œç›®å½•

```dockerfile
WORKDIR /app
```

**ä½œç”¨**ï¼šè®¾ç½®åç»­å‘½ä»¤çš„"å½“å‰ç›®å½•"ï¼Œç±»ä¼¼äº `cd /app`ã€‚

```
æ‰“ä¸ªæ¯”æ–¹ï¼š

ä½ å¼€äº†ä¸€å®¶å…¬å¸ï¼ˆå®¹å™¨ï¼‰ï¼Œéœ€è¦ä¸€ä¸ªåŠå…¬åœ°ç‚¹ï¼š
WORKDIR /app = æŠŠåŠå…¬åœ°ç‚¹è®¾åœ¨ /app ç›®å½•

ä¹‹åçš„æ‰€æœ‰æ“ä½œï¼ˆå¤åˆ¶æ–‡ä»¶ã€è¿è¡Œç¨‹åºï¼‰éƒ½åœ¨è¿™ä¸ªç›®å½•ä¸‹è¿›è¡Œ
```

**ä¸ºä»€ä¹ˆéœ€è¦ WORKDIRï¼Ÿ**
- è®©æ–‡ä»¶ç»„ç»‡æ›´æ¸…æ™°ï¼ˆæ‰€æœ‰åº”ç”¨æ–‡ä»¶éƒ½åœ¨ /app ä¸‹ï¼‰
- åç»­å‘½ä»¤å¯ä»¥ä½¿ç”¨ç›¸å¯¹è·¯å¾„
- ä¾¿äºç®¡ç†å’Œç»´æŠ¤

> [!NOTE]
> **å¸¸è§è¯¯è§£**ï¼šå¾ˆå¤šæ–°æ‰‹ä¼šé—®ã€Œä¸ºä»€ä¹ˆæˆ‘çš„é¡¹ç›®é‡Œæ²¡æœ‰ `app/` ç›®å½•ï¼Ÿã€
> 
> `/app` ç›®å½•**åªå­˜åœ¨äº Docker å®¹å™¨å†…éƒ¨**ï¼Œä¸æ˜¯ä½ ç”µè„‘ä¸Šçš„é¡¹ç›®ç›®å½•ï¼
> 
> | ç¯å¢ƒ | è·¯å¾„ | è¯´æ˜ |
> |------|------|------|
> | **ä½ çš„ç”µè„‘** | `/Users/xiexu/xiaofu/ai-rag-knowledge-study/` | é¡¹ç›®æºä»£ç æ‰€åœ¨åœ° |
> | **Docker å®¹å™¨å†…éƒ¨** | `/app/` | `WORKDIR` è‡ªåŠ¨åˆ›å»ºçš„å·¥ä½œç›®å½• |
> 
> Docker æ‰§è¡Œ `WORKDIR /app` æ—¶ä¼š**è‡ªåŠ¨åˆ›å»º**è¿™ä¸ªç›®å½•ï¼Œä½ æ— éœ€æ‰‹åŠ¨åˆ›å»ºã€‚

---

#### 5ï¸âƒ£ COPY - å¤åˆ¶æ–‡ä»¶åˆ°å®¹å™¨

```dockerfile
COPY target/ai-rag-knowledge-app-exec.jar /app/ai-rag-knowledge-app.jar
```

**ä½œç”¨**ï¼šæŠŠæœ¬åœ°ç”µè„‘ä¸Šçš„æ–‡ä»¶å¤åˆ¶åˆ°å®¹å™¨é‡Œé¢ã€‚

```
è¯­æ³•ï¼šCOPY <æœ¬åœ°è·¯å¾„> <å®¹å™¨å†…è·¯å¾„>

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  ä½ çš„ç”µè„‘ï¼ˆæ„å»ºæ—¶ï¼‰                                          â”‚
â”‚  â””â”€â”€ target/                                                â”‚
â”‚      â””â”€â”€ ai-rag-knowledge-app-exec.jar  â† æºæ–‡ä»¶           â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â”‚ COPY                                   â”‚
â”‚                    â–¼                                        â”‚
â”‚  Docker å®¹å™¨ï¼ˆè¿è¡Œæ—¶ï¼‰                                       â”‚
â”‚  â””â”€â”€ /app/                                                  â”‚
â”‚      â””â”€â”€ ai-rag-knowledge-app.jar  â† ç›®æ ‡æ–‡ä»¶              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„**ï¼š
- è¿™é‡Œè¿˜é¡ºä¾¿æ”¹äº†æ–‡ä»¶åï¼ˆå»æ‰äº† -exec åç¼€ï¼‰
- COPY åªåœ¨**æ„å»ºé•œåƒæ—¶**æ‰§è¡Œä¸€æ¬¡

---

#### 6ï¸âƒ£ EXPOSE - å£°æ˜ç«¯å£

```dockerfile
EXPOSE 8090
```

**ä½œç”¨**ï¼šå£°æ˜å®¹å™¨ä¼šä½¿ç”¨å“ªä¸ªç«¯å£ï¼ˆ**ä»…æ–‡æ¡£ä½œç”¨**ï¼Œä¸ä¼šçœŸæ­£å¼€æ”¾ç«¯å£ï¼‰ã€‚

```
æ‰“ä¸ªæ¯”æ–¹ï¼š

ä½ ç§Ÿäº†ä¸€ä¸ªå•†é“ºï¼ˆå®¹å™¨ï¼‰ï¼Œé—¨å£æŒ‚äº†ä¸ªç‰Œå­ï¼š
"æœ¬åº—åœ¨ 8090 å·çª—å£æä¾›æœåŠ¡"

è¿™ä¸ªç‰Œå­åªæ˜¯å‘Šè¯‰åˆ«äººä½ ç”¨å“ªä¸ªç«¯å£ï¼Œ
çœŸæ­£å¼€æ”¾ç«¯å£æ˜¯åœ¨ docker run -p 8090:8090 æ—¶åšçš„
```

**EXPOSE vs -p çš„åŒºåˆ«**ï¼š

| å‘½ä»¤ | ä½œç”¨ | æ—¶æœº |
|------|------|------|
| `EXPOSE 8090` | å£°æ˜/æ–‡æ¡£ä½œç”¨ | æ„å»ºé•œåƒæ—¶ |
| `docker run -p 8090:8090` | çœŸæ­£æ˜ å°„ç«¯å£ | è¿è¡Œå®¹å™¨æ—¶ |

---

#### 7ï¸âƒ£ ENTRYPOINT - å¯åŠ¨å‘½ä»¤

```dockerfile
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app/ai-rag-knowledge-app.jar --spring.profiles.active=dev $PARAMS"]
```

**ä½œç”¨**ï¼šå®¹å™¨å¯åŠ¨æ—¶è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆè¿™æ˜¯æœ€é‡è¦çš„ä¸€è¡Œï¼ï¼‰ã€‚

```
æŠŠè¿™ä¸ªå‘½ä»¤æ‹†å¼€ç†è§£ï¼š

["sh", "-c", "..."]
   â†“
ä½¿ç”¨ shell æ‰§è¡Œåé¢çš„å‘½ä»¤ï¼ˆè¿™æ ·æ‰èƒ½è§£æ $JAVA_OPTS ç­‰å˜é‡ï¼‰

"java $JAVA_OPTS -jar /app/ai-rag-knowledge-app.jar --spring.profiles.active=dev $PARAMS"
   â†“
å±•å¼€åå®é™…æ‰§è¡Œçš„å‘½ä»¤ï¼š
java -Xms512m -Xmx512m -jar /app/ai-rag-knowledge-app.jar --spring.profiles.active=dev
```

**å‘½ä»¤å„éƒ¨åˆ†å«ä¹‰**ï¼š

```
java                                    â†’ è¿è¡Œ Java ç¨‹åº
  $JAVA_OPTS                            â†’ æ’å…¥ JVM å‚æ•°ï¼ˆ-Xms512m -Xmx512mï¼‰
  -jar /app/ai-rag-knowledge-app.jar    â†’ è¿è¡Œè¿™ä¸ª JAR åŒ…
  --spring.profiles.active=dev          â†’ ä½¿ç”¨ dev é…ç½®æ–‡ä»¶
  $PARAMS                               â†’ é¢å¤–å‚æ•°ï¼ˆå¯é€šè¿‡ç¯å¢ƒå˜é‡ä¼ å…¥ï¼‰
```

---

### Dockerfile æ‰§è¡Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   docker build æ„å»ºè¿‡ç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Step 1: FROM eclipse-temurin:17-jre                          â”‚
â”‚           â†’ ä¸‹è½½ Java 17 åŸºç¡€é•œåƒ                                â”‚
â”‚                                                                 â”‚
â”‚   Step 2: LABEL maintainer="xiexu"                             â”‚
â”‚           â†’ æ·»åŠ ç»´æŠ¤è€…æ ‡ç­¾                                       â”‚
â”‚                                                                 â”‚
â”‚   Step 3: ENV JAVA_OPTS="-Xms512m -Xmx512m"                    â”‚
â”‚           â†’ è®¾ç½®ç¯å¢ƒå˜é‡                                         â”‚
â”‚                                                                 â”‚
â”‚   Step 4: RUN ln -snf /usr/share/zoneinfo/...                  â”‚
â”‚           â†’ è®¾ç½®æ—¶åŒº                                             â”‚
â”‚                                                                 â”‚
â”‚   Step 5: WORKDIR /app                                         â”‚
â”‚           â†’ åˆ›å»ºå¹¶è¿›å…¥ /app ç›®å½•                                 â”‚
â”‚                                                                 â”‚
â”‚   Step 6: COPY target/xxx.jar /app/xxx.jar                     â”‚
â”‚           â†’ æŠŠæœ¬åœ° JAR åŒ…å¤åˆ¶åˆ°å®¹å™¨                              â”‚
â”‚                                                                 â”‚
â”‚   Step 7: EXPOSE 8090                                          â”‚
â”‚           â†’ è®°å½•ç«¯å£å£°æ˜                                         â”‚
â”‚                                                                 â”‚
â”‚   âœ… é•œåƒæ„å»ºå®Œæˆï¼                                               â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   docker run è¿è¡Œè¿‡ç¨‹                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Step 8: ENTRYPOINT ["sh", "-c", "java ..."]                  â”‚
â”‚           â†’ å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œè¿™ä¸ªå‘½ä»¤                                â”‚
â”‚           â†’ Spring Boot åº”ç”¨å¼€å§‹è¿è¡Œ                            â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å¸¸è§é—®é¢˜

**Q: COPY å’Œ ADD æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
- COPYï¼šå•çº¯å¤åˆ¶æ–‡ä»¶
- ADDï¼šå¯ä»¥è§£å‹ tar åŒ…ã€ä¸‹è½½ URLï¼ˆä¸æ¨èä½¿ç”¨ï¼ŒåŠŸèƒ½å¤ªå¤æ‚ï¼‰

**Q: ENTRYPOINT å’Œ CMD æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
- ENTRYPOINTï¼šå®¹å™¨çš„"ä¸»ç¨‹åº"ï¼Œä¸€èˆ¬ä¸è¢«è¦†ç›–
- CMDï¼šé»˜è®¤å‚æ•°ï¼Œå¯ä»¥è¢« `docker run` åé¢çš„å‚æ•°è¦†ç›–

**Q: ä¸ºä»€ä¹ˆç”¨ `["sh", "-c", "..."]` è€Œä¸æ˜¯ç›´æ¥å†™å‘½ä»¤ï¼Ÿ**
- ç›´æ¥å†™ `["java", "-jar", "..."]` ä¸èƒ½è§£æ `$JAVA_OPTS` å˜é‡
- ç”¨ `sh -c` å¯ä»¥è®© shell å¸®æˆ‘ä»¬è§£æå˜é‡

## ğŸ—ï¸ æ„å»º Docker é•œåƒ

### æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨æ„å»º

```bash
cd /Users/xiexu/xiaofu/ai-rag-knowledge-study

# æ„å»ºé•œåƒ
docker build \
  -t ai-rag-knowledge-app:1.0 \
  -f .claude/docker-deploy/Dockerfile \
  xfg-dev-tech-app/

# æŸ¥çœ‹æ„å»ºçš„é•œåƒ
docker images | grep ai-rag-knowledge-app
```

### æ–¹å¼äºŒï¼šä½¿ç”¨éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

é¡¹ç›®æä¾›äº†è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼Œä¼šå®Œæˆæ„å»ºå’Œå¯åŠ¨ï¼š

```bash
cd .claude/docker-deploy

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
./scripts/deploy.sh
```

---

## ğŸ“„ ç†è§£ docker-compose.yml

### ç¯å¢ƒå˜é‡æ–‡ä»¶ .env

åœ¨ä»‹ç» `docker-compose.yml` ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸ªé‡è¦çš„é…å¥—æ–‡ä»¶ï¼š`.env`

**ä»€ä¹ˆæ˜¯ .env æ–‡ä»¶ï¼Ÿ**

`.env` æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨ç¯å¢ƒå˜é‡ã€‚Docker Compose è¿è¡Œæ—¶ä¼šè‡ªåŠ¨è¯»å–è¿™ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†å˜é‡æ³¨å…¥åˆ°é…ç½®ä¸­ã€‚

```
æ‰“ä¸ªæ¯”æ–¹ï¼š

docker-compose.yml æ˜¯ä¸€ä»½è®¢å•æ¨¡æ¿ï¼Œé‡Œé¢æœ‰äº›å†…å®¹æ˜¯ç©ºçš„ï¼š
"è¯·ç»™æˆ‘ ___ æ¯å’–å•¡ï¼ŒåŠ  ___ ç³–"

.env æ–‡ä»¶å°±æ˜¯å¡«ç©ºçš„ç­”æ¡ˆï¼š
æ¯æ•°=2
ç³–é‡=å°‘

è¿è¡Œæ—¶è‡ªåŠ¨å¡«å……ï¼š
"è¯·ç»™æˆ‘ 2 æ¯å’–å•¡ï¼ŒåŠ  å°‘ ç³–"
```

---

**é¡¹ç›®çš„ .env æ–‡ä»¶å†…å®¹**ï¼š

```env
# åº”ç”¨é…ç½®
APP_VERSION=1.0
APP_PORT=8090

# JVM é…ç½®
JAVA_OPTS=-Xms512m -Xmx512m

# Spring é…ç½®
SPRING_PROFILE=dev

# PostgreSQL é…ç½®
DB_URL=jdbc:postgresql://vector_db:5432/ai-rag-knowledge
DB_USER=postgres
DB_PASSWORD=postgres

# Ollama é…ç½®
OLLAMA_URL=http://ollama:11434

# Redis é…ç½®
REDIS_HOST=redis
REDIS_PORT=6379

# æ—¥å¿—é…ç½®
LOG_PATH=./logs
```

---

**å¦‚ä½•åœ¨ docker-compose.yml ä¸­ä½¿ç”¨ï¼Ÿ**

ä½¿ç”¨ `${å˜é‡å}` è¯­æ³•å¼•ç”¨ .env ä¸­çš„å˜é‡ï¼š

```yaml
services:
  ai-rag-knowledge-app:
    image: ai-rag-knowledge-app:${APP_VERSION}    # å¼•ç”¨ APP_VERSION=1.0
    ports:
      - "${APP_PORT}:8090"                         # å¼•ç”¨ APP_PORT=8090
    environment:
      - JAVA_OPTS=${JAVA_OPTS}                     # å¼•ç”¨ JAVA_OPTS
      - SPRING_DATASOURCE_URL=${DB_URL}            # å¼•ç”¨ DB_URL
      - SPRING_DATASOURCE_USERNAME=${DB_USER}      # å¼•ç”¨ DB_USER
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}  # å¼•ç”¨ DB_PASSWORD
```

---

**ä¸ºä»€ä¹ˆè¦ç”¨ .env æ–‡ä»¶ï¼Ÿ**

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| **é…ç½®åˆ†ç¦»** | æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ç­‰ï¼‰ä¸å†™æ­»åœ¨ docker-compose.yml ä¸­ |
| **ç¯å¢ƒåˆ‡æ¢** | å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒåªéœ€æ¢ä¸åŒçš„ .env æ–‡ä»¶ |
| **ä¾¿äºç®¡ç†** | æ‰€æœ‰é…ç½®å˜é‡é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€ç›®äº†ç„¶ |
| **å®‰å…¨æ€§** | å¯ä»¥æŠŠ .env åŠ å…¥ .gitignoreï¼Œä¸æäº¤åˆ° Git |

---

> [!WARNING]
> **å®‰å…¨æé†’**ï¼š
> - ä¸è¦æŠŠåŒ…å«**çœŸå®å¯†ç **çš„ `.env` æ–‡ä»¶æäº¤åˆ° Gitï¼
> - é€šå¸¸åšæ³•ï¼šæä¾›ä¸€ä¸ª `.env.example` ç¤ºä¾‹æ–‡ä»¶ï¼ŒçœŸå®çš„ `.env` åŠ å…¥ `.gitignore`
> - æœ¬é¡¹ç›®çš„ `.env` ä¸­ä½¿ç”¨çš„æ˜¯é»˜è®¤å¼€å‘å¯†ç ï¼Œä»…ç”¨äºæœ¬åœ°å¼€å‘

---

### docker-compose.yml å®Œæ•´å†…å®¹

é¡¹ç›®ä½¿ç”¨çš„ `docker-compose.yml` å®Œæ•´å†…å®¹å¦‚ä¸‹ï¼š

```yaml
version: '3.8'

services:
  # Nginx å‰ç«¯æœåŠ¡ (HTTPS)
  nginx:
    image: nginx:1.25.1
    container_name: nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./certs:/etc/nginx/certs
    depends_on:
      - ai-rag-knowledge-app
    networks:
      - binghe-network
    healthcheck:
      test: ["CMD", "curl", "-kf", "https://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Spring Boot åç«¯æœåŠ¡
  ai-rag-knowledge-app:
    build:
      context: ../../xfg-dev-tech-app
      dockerfile: ../.claude/docker-deploy/Dockerfile
    image: ai-rag-knowledge-app:${APP_VERSION:-1.0}
    container_name: ai-rag-knowledge-app
    restart: on-failure
    ports:
      - "${APP_PORT:-8090}:8090"
    environment:
      - TZ=PRC
      - JAVA_OPTS=-Xms512m -Xmx512m
      - SERVER_PORT=8090
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_DATASOURCE_URL=${DB_URL:-jdbc:postgresql://vector_db:5432/ai-rag-knowledge}
      - SPRING_DATASOURCE_USERNAME=${DB_USER:-postgres}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD:-postgres}
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - SPRING_AI_OLLAMA_BASE_URL=${OLLAMA_URL:-http://ollama:11434}
      - REDIS_SDK_CONFIG_HOST=${REDIS_HOST:-redis}
      - REDIS_SDK_CONFIG_PORT=${REDIS_PORT:-6379}
    volumes:
      - ${LOG_PATH:-./logs}:/app/data/log
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - binghe-network

networks:
  binghe-network:
    external: true
```

> [!NOTE]
> **å˜é‡å¼•ç”¨è¯­æ³•**ï¼š`${VAR:-default}` è¡¨ç¤ºå¼•ç”¨ `.env` ä¸­çš„ `VAR` å˜é‡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ `default` é»˜è®¤å€¼ã€‚

> [!TIP]
> å…ˆé€šè¯»ä¸€éå®Œæ•´é…ç½®ï¼Œæœ‰ä¸ªæ•´ä½“å°è±¡ï¼Œç„¶åå†çœ‹ä¸‹é¢çš„é€è¡Œè¯¦è§£ã€‚

---

### docker-compose.yml é€è¡Œè¯¦è§£

ä¸‹é¢æˆ‘ä»¬é€è¡Œè§£é‡Šæ¯ä¸ªé…ç½®çš„ä½œç”¨ï¼š

```yaml
version: '3.8'
```
**ç‰ˆæœ¬å£°æ˜**ï¼šä½¿ç”¨ Docker Compose æ–‡ä»¶æ ¼å¼ 3.8 ç‰ˆæœ¬ã€‚ä¸åŒç‰ˆæœ¬æ”¯æŒçš„åŠŸèƒ½ä¸åŒï¼Œ3.8 æ˜¯ç›®å‰è¾ƒæ–°ä¸”ç¨³å®šçš„ç‰ˆæœ¬ã€‚

---

```yaml
services:
```
**æœåŠ¡å®šä¹‰å¼€å§‹**ï¼š`services` ä¸‹é¢å®šä¹‰æ‰€æœ‰è¦è¿è¡Œçš„å®¹å™¨æœåŠ¡ã€‚

---

#### ğŸŒ Nginx å‰ç«¯æœåŠ¡

```yaml
  nginx:                              # æœåŠ¡åç§°ï¼Œå¯ä»¥è‡ªå®šä¹‰
    image: nginx:1.25.1               # ä½¿ç”¨ç°æˆçš„ Nginx é•œåƒï¼ˆä¸éœ€è¦ buildï¼‰
    container_name: nginx             # å®¹å™¨åç§°ï¼Œdocker ps æ—¶æ˜¾ç¤ºçš„åå­—
    restart: always                   # é‡å¯ç­–ç•¥ï¼šå®¹å™¨åœæ­¢åæ€»æ˜¯è‡ªåŠ¨é‡å¯
```

| restart ç­–ç•¥ | è¯´æ˜ |
|-------------|------|
| `no` | ä¸è‡ªåŠ¨é‡å¯ï¼ˆé»˜è®¤ï¼‰ |
| `always` | æ€»æ˜¯é‡å¯ï¼ˆé™¤éæ‰‹åŠ¨åœæ­¢ï¼‰ |
| `on-failure` | åªåœ¨å¼‚å¸¸é€€å‡ºæ—¶é‡å¯ |
| `unless-stopped` | æ€»æ˜¯é‡å¯ï¼Œé™¤éæ‰‹åŠ¨åœæ­¢ |

```yaml
    ports:
      - "80:80"                       # å®¿ä¸»æœº80ç«¯å£ â†’ å®¹å™¨80ç«¯å£ï¼ˆHTTPï¼‰
      - "443:443"                     # å®¿ä¸»æœº443ç«¯å£ â†’ å®¹å™¨443ç«¯å£ï¼ˆHTTPSï¼‰
```

**ç«¯å£æ˜ å°„æ ¼å¼**ï¼š`å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä½ çš„ç”µè„‘    â”‚         â”‚  Nginx å®¹å™¨   â”‚
â”‚              â”‚         â”‚              â”‚
â”‚  :80 â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ :80          â”‚
â”‚  :443 â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ :443         â”‚
â”‚              â”‚         â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     å®¿ä¸»æœº                    å®¹å™¨
```

```yaml
    volumes:
      - ./frontend:/usr/share/nginx/html         # å‰ç«¯é™æ€æ–‡ä»¶
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf # Nginx ä¸»é…ç½®
      - ./nginx/conf.d:/etc/nginx/conf.d         # Nginx ç«™ç‚¹é…ç½®
      - ./certs:/etc/nginx/certs                 # SSL è¯ä¹¦
```

**å·æŒ‚è½½æ ¼å¼**ï¼š`å®¿ä¸»æœºè·¯å¾„:å®¹å™¨å†…è·¯å¾„`

> [!NOTE]
> **ç›¸å¯¹è·¯å¾„è¯´æ˜**ï¼š`./` å¼€å¤´çš„è·¯å¾„æ˜¯ç›¸å¯¹äº `docker-compose.yml` æ–‡ä»¶æ‰€åœ¨ç›®å½•ã€‚
> 
> ç”±äº `docker-compose.yml` ä½äº `/Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy/`ï¼Œæ‰€ä»¥ï¼š
> 
> | ç›¸å¯¹è·¯å¾„ | å¯¹åº”çš„å®¿ä¸»æœºç»å¯¹è·¯å¾„ |
> |----------|----------------------|
> | `./frontend` | `/Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy/frontend/` |
> | `./nginx/nginx.conf` | `/Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy/nginx/nginx.conf` |
> | `./nginx/conf.d` | `/Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy/nginx/conf.d/` |
> | `./certs` | `/Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy/certs/` |
> 
> å·æŒ‚è½½çš„ä½œç”¨æ˜¯è®©å®¹å™¨å¯ä»¥è®¿é—®å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ã€‚ä¿®æ”¹å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶ï¼Œå®¹å™¨å†…ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°æ„å»ºé•œåƒã€‚

```yaml
    depends_on:
      - ai-rag-knowledge-app          # Nginx ä¾èµ–åç«¯åº”ç”¨
```

**å¯åŠ¨é¡ºåºæ§åˆ¶**ï¼šNginx ä¼šç­‰å¾… `ai-rag-knowledge-app` å®¹å™¨å¯åŠ¨åæ‰å¯åŠ¨ã€‚

> [!WARNING]
> `depends_on` åªä¿è¯å¯åŠ¨é¡ºåºï¼Œä¸ä¿è¯ä¾èµ–æœåŠ¡ã€Œå®Œå…¨å°±ç»ªã€ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ `healthcheck`ã€‚

```yaml
    networks:
      - binghe-network                # åŠ å…¥æŒ‡å®šç½‘ç»œ
```

**ç½‘ç»œé…ç½®**ï¼šè®© Nginx å¯ä»¥é€šè¿‡å®¹å™¨åè®¿é—®åŒç½‘ç»œä¸­çš„å…¶ä»–æœåŠ¡ã€‚

---

#### â˜• Spring Boot åç«¯æœåŠ¡

```yaml
  ai-rag-knowledge-app:               # æœåŠ¡åç§°
    build:
      context: ../../xfg-dev-tech-app           # æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ï¼ˆDockerfile ä¸­ COPY çš„ç›¸å¯¹è·¯å¾„åŸºäºæ­¤ï¼‰
      dockerfile: ../.claude/docker-deploy/Dockerfile  # Dockerfile çš„ä½ç½®
```

**build é…ç½®**ï¼šå‘Šè¯‰ Docker Compose å¦‚ä½•æ‰¾åˆ°å¹¶ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒã€‚

- `context`ï¼šæ„å»ºä¸Šä¸‹æ–‡ï¼ŒDockerfile ä¸­çš„ `COPY` å‘½ä»¤ç›¸å¯¹äºè¿™ä¸ªç›®å½•
- `dockerfile`ï¼šDockerfile æ–‡ä»¶çš„è·¯å¾„ï¼ˆç›¸å¯¹äº docker-compose.ymlï¼‰

> [!NOTE]
> **ä»€ä¹ˆæ˜¯æ„å»ºä¸Šä¸‹æ–‡ï¼Ÿ**
> 
> æ„å»ºä¸Šä¸‹æ–‡å°±æ˜¯ Docker åœ¨æ„å»ºé•œåƒæ—¶èƒ½å¤Ÿ"çœ‹åˆ°"çš„æ–‡ä»¶èŒƒå›´ã€‚
> 
> ```
> æ‰“ä¸ªæ¯”æ–¹ï¼š
> 
> ä½ åœ¨åšé¥­ï¼ˆæ„å»ºé•œåƒï¼‰ï¼Œå¨æˆ¿çš„æ“ä½œå°ï¼ˆæ„å»ºä¸Šä¸‹æ–‡ï¼‰ä¸Šæ”¾ç€é£Ÿæã€‚
> ä½ åªèƒ½ç”¨æ“ä½œå°ä¸Šçš„é£Ÿæï¼å†°ç®±é‡Œçš„ä¸œè¥¿ï¼ˆæ“ä½œå°å¤–çš„æ–‡ä»¶ï¼‰ä½ æ˜¯æ‹¿ä¸åˆ°çš„ã€‚
> 
> æ„å»ºä¸Šä¸‹æ–‡ = æ“ä½œå°ä¸Šèƒ½ç”¨çš„æ‰€æœ‰é£Ÿæ
> ```

**è·¯å¾„è®¡ç®—ç¤ºä¾‹**ï¼š

```
docker-compose.yml ä½ç½®ï¼š
/Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy/docker-compose.yml

context: ../../xfg-dev-tech-app è®¡ç®—åçš„ç»å¯¹è·¯å¾„ï¼š
/Users/xiexu/xiaofu/ai-rag-knowledge-study/xfg-dev-tech-app/
                                          â†‘
                                    è¿™å°±æ˜¯æ„å»ºä¸Šä¸‹æ–‡
```

**COPY å‘½ä»¤å¦‚ä½•å·¥ä½œ**ï¼š

Dockerfile ä¸­æœ‰è¿™è¡Œï¼š
```dockerfile
COPY target/ai-rag-knowledge-app-exec.jar /app/ai-rag-knowledge-app.jar
```

`target/xxx.jar` æ˜¯ç›¸å¯¹äº**æ„å»ºä¸Šä¸‹æ–‡**çš„è·¯å¾„ï¼Œä¸æ˜¯ç›¸å¯¹äº Dockerfile çš„è·¯å¾„ï¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„å»ºä¸Šä¸‹æ–‡ = /Users/xiexu/.../xfg-dev-tech-app/               â”‚
â”‚                                                                 â”‚
â”‚  â”œâ”€â”€ target/                                                    â”‚
â”‚  â”‚   â””â”€â”€ ai-rag-knowledge-app-exec.jar  â† COPY èƒ½æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶  â”‚
â”‚  â”œâ”€â”€ src/                                                       â”‚
â”‚  â””â”€â”€ pom.xml                                                    â”‚
â”‚                                                                 â”‚
â”‚  COPY target/xxx.jar /app/xxx.jar                               â”‚
â”‚       â†‘                                                         â”‚
â”‚       ç›¸å¯¹äºæ„å»ºä¸Šä¸‹æ–‡çš„è·¯å¾„                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> [!WARNING]
> **å¸¸è§è¯¯è§£**ï¼š
> - âŒ COPY è·¯å¾„ç›¸å¯¹äº Dockerfile â†’ âœ… COPY è·¯å¾„ç›¸å¯¹äº**æ„å»ºä¸Šä¸‹æ–‡**
> - å¦‚æœæ„å»ºä¸Šä¸‹æ–‡é…ç½®é”™è¯¯ï¼Œä¼šæŠ¥é”™ï¼š`COPY failed: file not found in build context`

```yaml
    image: ai-rag-knowledge-app:1.0   # æ„å»ºåçš„é•œåƒåç§°å’Œæ ‡ç­¾
    container_name: ai-rag-knowledge-app  # å®¹å™¨åç§°
    restart: on-failure               # åªåœ¨å¼‚å¸¸é€€å‡ºæ—¶é‡å¯
```

```yaml
    ports:
      - "8090:8090"                   # Spring Boot åº”ç”¨ç«¯å£
```

```yaml
    environment:                      # ç¯å¢ƒå˜é‡ï¼ˆä¼šè¦†ç›– Dockerfile ä¸­çš„ ENV é»˜è®¤å€¼ï¼‰
      - TZ=PRC                        # æ—¶åŒºè®¾ç½®
      - JAVA_OPTS=-Xms512m -Xmx512m   # JVM å†…å­˜å‚æ•°
      - SPRING_DATASOURCE_URL=jdbc:postgresql://vector_db:5432/ai-rag-knowledge
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_AI_OLLAMA_BASE_URL=http://ollama:11434
      - REDIS_SDK_CONFIG_HOST=redis
      - REDIS_SDK_CONFIG_PORT=6379
```

> [!IMPORTANT]
> **ç¯å¢ƒå˜é‡ä¸­çš„æœåŠ¡å**ï¼šæ³¨æ„ `vector_db`ã€`ollama`ã€`redis` è¿™äº›æ˜¯å®¹å™¨åç§°ï¼Œä¸æ˜¯ IP åœ°å€ã€‚
> 
> åœ¨åŒä¸€ä¸ª Docker ç½‘ç»œä¸­ï¼Œå®¹å™¨å¯ä»¥é€šè¿‡åç§°äº’ç›¸è®¿é—®ï¼ŒDocker ä¼šè‡ªåŠ¨è§£æä¸ºå¯¹åº”å®¹å™¨çš„ IPã€‚

**ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§**ï¼š
```
docker-compose.yml ä¸­çš„ environment  â†’  è¦†ç›–  â†’  Dockerfile ä¸­çš„ ENV
```

```yaml
    volumes:
      - /Users/xiexu/logs:/app/data/log   # æ—¥å¿—æ–‡ä»¶æŒ‚è½½åˆ°å®¿ä¸»æœº
```

**æ—¥å¿—æŒä¹…åŒ–**ï¼šå®¹å™¨å†… `/app/data/log` ç›®å½•çš„æ—¥å¿—ä¼šå†™å…¥å®¿ä¸»æœº `/Users/xiexu/logs`ï¼Œå®¹å™¨åˆ é™¤åæ—¥å¿—ä»ç„¶ä¿ç•™ã€‚

```yaml
    healthcheck:                      # å¥åº·æ£€æŸ¥é…ç½®
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s                   # æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
      timeout: 10s                    # æ£€æŸ¥è¶…æ—¶æ—¶é—´
      retries: 3                      # è¿ç»­å¤±è´¥ 3 æ¬¡æ‰æ ‡è®°ä¸º unhealthy
      start_period: 60s               # å¯åŠ¨åç­‰å¾… 60 ç§’å†å¼€å§‹æ£€æŸ¥ï¼ˆSpring Boot å¯åŠ¨æ…¢ï¼‰
```

**å¥åº·æ£€æŸ¥çš„ä½œç”¨**ï¼š
- `docker ps` æ˜¾ç¤ºå®¹å™¨å¥åº·çŠ¶æ€ï¼ˆhealthy/unhealthyï¼‰
- é…åˆ `depends_on` çš„ `condition: service_healthy` å¯ä»¥ç¡®ä¿ä¾èµ–æœåŠ¡å®Œå…¨å°±ç»ª

```yaml
    networks:
      - binghe-network
```

---

#### ğŸ”— ç½‘ç»œé…ç½®

```yaml
networks:
  binghe-network:
    external: true                    # ä½¿ç”¨å·²å­˜åœ¨çš„å¤–éƒ¨ç½‘ç»œï¼ˆä¸ç”± docker-compose åˆ›å»ºï¼‰
```

| external å€¼ | è¯´æ˜ |
|------------|------|
| `true` | ç½‘ç»œå¿…é¡»äº‹å…ˆå­˜åœ¨ï¼Œdocker-compose ä¸ä¼šåˆ›å»º |
| `false`ï¼ˆé»˜è®¤ï¼‰ | docker-compose ä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªç½‘ç»œ |

**ä¸ºä»€ä¹ˆç”¨ external: trueï¼Ÿ**
- ä¸­é—´ä»¶ï¼ˆPostgreSQLã€Redisã€Ollamaï¼‰å·²ç»åœ¨ `binghe-network` ç½‘ç»œä¸­è¿è¡Œ
- åº”ç”¨éœ€è¦åŠ å…¥åŒä¸€ä¸ªç½‘ç»œæ‰èƒ½è®¿é—®å®ƒä»¬
- é¿å… docker-compose down æ—¶æ„å¤–åˆ é™¤å…±äº«ç½‘ç»œ

---

### å…³é”®é…ç½®é€ŸæŸ¥è¡¨

| é…ç½® | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `image` | ä½¿ç”¨ç°æˆé•œåƒ | `nginx:1.25.1` |
| `build` | ä» Dockerfile æ„å»ºé•œåƒ | `context + dockerfile` |
| `ports` | ç«¯å£æ˜ å°„ | `"8090:8090"` |
| `volumes` | æ–‡ä»¶/ç›®å½•æŒ‚è½½ | `/host/path:/container/path` |
| `environment` | ç¯å¢ƒå˜é‡ | `KEY=value` |
| `depends_on` | å¯åŠ¨é¡ºåºä¾èµ– | æœåŠ¡ååˆ—è¡¨ |
| `networks` | å®¹å™¨ç½‘ç»œ | ç½‘ç»œååˆ—è¡¨ |
| `healthcheck` | å¥åº·æ£€æŸ¥ | test + interval + timeout |
| `restart` | é‡å¯ç­–ç•¥ | `always`/`on-failure`/`no` |

---

### Dockerfile ä¸ docker-compose.yml çš„å…³ç³»

> å¾ˆå¤šæ–°æ‰‹ä¼šå›°æƒ‘ï¼šã€ŒDockerfile å’Œ docker-compose.yml æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿæ€ä¹ˆé…åˆä½¿ç”¨ï¼Ÿã€

**ä¸€å¥è¯æ€»ç»“**ï¼š

| æ–‡ä»¶ | ä½œç”¨ | ç±»æ¯” |
|------|------|------|
| **Dockerfile** | å®šä¹‰å¦‚ä½•**åˆ¶ä½œ**ä¸€ä¸ªé•œåƒ | ğŸ• **æŠ«è¨é…æ–¹** |
| **docker-compose.yml** | å®šä¹‰å¦‚ä½•**è¿è¡Œ**ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ | ğŸ½ï¸ **é¤å…èœå• + ä¸Šèœæµç¨‹** |

```
æ‰“ä¸ªæ¯”æ–¹ï¼šå¼€ä¸€å®¶æŠ«è¨åº—

ğŸ“ Dockerfile = æŠ«è¨é…æ–¹
   å‘Šè¯‰å¨å¸ˆæ€ä¹ˆåšä¸€ä¸ªæŠ«è¨ï¼š
   1. å‡†å¤‡é¢å›¢ï¼ˆFROM åŸºç¡€é•œåƒï¼‰
   2. åŠ ç•ªèŒ„é…±ï¼ˆCOPY å¤åˆ¶æ–‡ä»¶ï¼‰
   3. æ’’èŠå£«ï¼ˆRUN å®‰è£…ä¾èµ–ï¼‰
   4. çƒ¤åˆ¶å®Œæˆï¼ï¼ˆç”Ÿæˆé•œåƒï¼‰

ğŸ“‹ docker-compose.yml = é¤å…è¿è¥æ‰‹å†Œ
   å‘Šè¯‰æœåŠ¡å‘˜æ€ä¹ˆè¿è¥é¤å…ï¼š
   1. æŠ«è¨ç”¨ Dockerfile é…æ–¹åˆ¶ä½œï¼ˆbuildï¼‰
   2. æŠ«è¨å”®ä»· $10ï¼Œé…å¯ä¹ï¼ˆportsã€environmentï¼‰
   3. å…ˆå¯åŠ¨çƒ¤ç®±ï¼Œå†åšæŠ«è¨ï¼ˆdepends_on å¯åŠ¨é¡ºåºï¼‰
   4. æŠ«è¨å’Œæ²™æ‹‰åœ¨åŒä¸€ä¸ªé¤å…ï¼ˆnetworks ç½‘ç»œï¼‰
```

---

### æ‰§è¡Œ `docker compose up --build` æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: docker compose è¯»å– docker-compose.yml             â”‚
â”‚          å‘ç° ai-rag-knowledge-app æœåŠ¡æœ‰ build é…ç½®        â”‚
â”‚                         â†“                                   â”‚
â”‚  Step 2: æ ¹æ® build.dockerfile æ‰¾åˆ° Dockerfile              â”‚
â”‚          æ ¹æ® build.context ç¡®å®šæ„å»ºä¸Šä¸‹æ–‡ç›®å½•               â”‚
â”‚                         â†“                                   â”‚
â”‚  Step 3: æ‰§è¡Œ Dockerfile ä¸­çš„æŒ‡ä»¤                            â”‚
â”‚          FROM â†’ LABEL â†’ ENV â†’ WORKDIR â†’ COPY â†’ EXPOSE       â”‚
â”‚          ç”Ÿæˆé•œåƒ ai-rag-knowledge-app:1.0                   â”‚
â”‚                         â†“                                   â”‚
â”‚  Step 4: docker compose ç”¨è¿™ä¸ªé•œåƒå¯åŠ¨å®¹å™¨                   â”‚
â”‚          åº”ç”¨ portsã€environmentã€volumes ç­‰é…ç½®             â”‚
â”‚          æ‰§è¡Œ ENTRYPOINT å¯åŠ¨åº”ç”¨                            â”‚
â”‚                         â†“                                   â”‚
â”‚  Step 5: æ ¹æ® depends_on é¡ºåºå¯åŠ¨å…¶ä»–æœåŠ¡ï¼ˆå¦‚ Nginxï¼‰        â”‚
â”‚          æ‰€æœ‰æœåŠ¡åŠ å…¥ binghe-network ç½‘ç»œ                    â”‚
â”‚                                                             â”‚
â”‚  âœ… éƒ¨ç½²å®Œæˆï¼                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### å¸¸è§é—®é¢˜

**Q: Dockerfile å’Œ docker-compose.yml ä¸­éƒ½èƒ½è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨å“ªä¸ªï¼Ÿ**

```dockerfile
# Dockerfile ä¸­è®¾ç½®é»˜è®¤å€¼
ENV JAVA_OPTS="-Xms256m -Xmx256m"
```

```yaml
# docker-compose.yml ä¸­è¦†ç›–
environment:
  - JAVA_OPTS=-Xms512m -Xmx512m   # è¿™ä¸ªä¼šè¦†ç›– Dockerfile ä¸­çš„é»˜è®¤å€¼
```

**ç»“è®º**ï¼šdocker-compose.yml ä¼˜å…ˆçº§æ›´é«˜ï¼Œä¼šè¦†ç›– Dockerfile ä¸­çš„é»˜è®¤å€¼ã€‚

**Q: ä¸ºä»€ä¹ˆä¸èƒ½åªç”¨ Dockerfileï¼Ÿ**

- Dockerfile åªèƒ½å®šä¹‰**å•ä¸ªé•œåƒ**æ€ä¹ˆæ„å»º
- ç°å®ä¸­ä¸€ä¸ªåº”ç”¨éœ€è¦**å¤šä¸ªæœåŠ¡**ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€åç«¯ã€å‰ç«¯...ï¼‰
- docker-compose.yml å¯ä»¥**ç¼–æ’å¤šä¸ªå®¹å™¨**ä¸€èµ·å·¥ä½œï¼Œå®šä¹‰ç½‘ç»œã€ç«¯å£ã€å¯åŠ¨é¡ºåºç­‰

---

## ğŸš€ å¯åŠ¨åº”ç”¨

### å‡†å¤‡å·¥ä½œ

```bash
cd /Users/xiexu/xiaofu/ai-rag-knowledge-study/.claude/docker-deploy

# 1. ç¡®ä¿æ—¥å¿—ç›®å½•å­˜åœ¨
mkdir -p /Users/xiexu/logs

# 2. ç”Ÿæˆ SSL è¯ä¹¦ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
./scripts/gen-ssl-cert.sh

# 3. åŒæ­¥å‰ç«¯é™æ€èµ„æº
mkdir -p frontend
cp -r ../../xfg-dev-tech-app/src/main/resources/static/* frontend/
```

### å¯åŠ¨æœåŠ¡

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d --build

# æŸ¥çœ‹å¯åŠ¨çŠ¶æ€
docker compose ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose logs

# æŒç»­è·Ÿè¸ªåº”ç”¨æ—¥å¿—
docker compose logs -f ai-rag-knowledge-app

# æŸ¥çœ‹å®¿ä¸»æœºæ—¥å¿—æ–‡ä»¶
tail -f /Users/xiexu/logs/*.log
```

---

## âœ… éªŒè¯éƒ¨ç½²

### 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€

```bash
docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
```

é¢„æœŸè¾“å‡ºï¼ˆçŠ¶æ€åº”ä¸º `healthy`ï¼‰ï¼š

```
NAMES                    STATUS                   PORTS
nginx                    Up X minutes (healthy)   0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp
ai-rag-knowledge-app     Up X minutes (healthy)   0.0.0.0:8090->8090/tcp
```

### 2. æµ‹è¯•åç«¯ API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8090/actuator/health
# é¢„æœŸï¼š{"status":"UP",...}

# æµ‹è¯• APIï¼ˆå¦‚æœæœ‰ï¼‰
curl http://localhost:8090/api/xxx
```

### 3. æµ‹è¯•å‰ç«¯è®¿é—®

```bash
# HTTP åº”é‡å®šå‘åˆ° HTTPS
curl -I http://localhost
# é¢„æœŸï¼š301 Moved Permanently

# HTTPS è®¿é—®ï¼ˆ-k å¿½ç•¥è‡ªç­¾åè¯ä¹¦è­¦å‘Šï¼‰
curl -k https://localhost
```

æˆ–åœ¨æµè§ˆå™¨è®¿é—® `https://localhost`ï¼ˆé¦–æ¬¡ä¼šæç¤ºè¯ä¹¦ä¸å®‰å…¨ï¼Œç‚¹å‡»"ç»§ç»­è®¿é—®"ï¼‰ã€‚

---

## ğŸ”„ æ—¥å¸¸æ“ä½œ

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker compose restart

# ä»…é‡å¯åº”ç”¨
docker compose restart ai-rag-knowledge-app
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™é•œåƒå’Œå·ï¼‰
docker compose down

# åœæ­¢ä½†ä¿ç•™å®¹å™¨
docker compose stop
```

### æ›´æ–°éƒ¨ç½²

ä»£ç æ›´æ–°åï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```bash
# 1. é‡æ–°æ„å»º JAR
cd /Users/xiexu/xiaofu/ai-rag-knowledge-study
mvn clean package -DskipTests

# 2. é‡æ–°æ„å»ºé•œåƒå¹¶å¯åŠ¨
cd .claude/docker-deploy
docker compose up -d --build
```

---

## âœ… æœ¬ç« æ£€æŸ¥æ¸…å•

åœ¨è¿›å…¥ä¸‹ä¸€ç« ä¹‹å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] `docker compose ps` æ˜¾ç¤ºä¸¤ä¸ªæœåŠ¡è¿è¡Œä¸­
- [ ] `curl http://localhost:8090/actuator/health` è¿”å› `UP`
- [ ] æµè§ˆå™¨å¯è®¿é—® https://localhost
- [ ] æ—¥å¿—æ–‡ä»¶æ­£ç¡®å†™å…¥ `/Users/xiexu/logs/`

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| ä¸Šä¸€ç¯‡ | ä¸‹ä¸€ç¯‡ |
|--------|--------|
| [04-ä¸­é—´ä»¶éƒ¨ç½²](./04-ä¸­é—´ä»¶éƒ¨ç½².md) | [06-Nginx é…ç½®](./06-Nginxé…ç½®.md) |

[è¿”å›ç›®å½•](./README.md)
