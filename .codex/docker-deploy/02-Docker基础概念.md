# 02 - Docker åŸºç¡€æ¦‚å¿µ

> æœ¬ç« ä»‹ç» Docker æ ¸å¿ƒæ¦‚å¿µï¼Œå¸®åŠ©ä½ ç†è§£å®¹å™¨åŒ–æŠ€æœ¯çš„åŸºæœ¬åŸç†ã€‚

---

## ğŸ“‹ æœ¬ç« ç›®æ ‡

å®Œæˆæœ¬ç« åï¼Œä½ å°†ç†è§£ï¼š
- âœ… é•œåƒ (Image) ä¸å®¹å™¨ (Container) çš„å…³ç³»
- âœ… Docker ç½‘ç»œå¦‚ä½•å·¥ä½œ
- âœ… æ•°æ®æŒä¹…åŒ–ï¼ˆå·æŒ‚è½½ï¼‰
- âœ… Docker Compose çš„ä½œç”¨

---

## ğŸ–¼ï¸ é•œåƒ (Image)

### ä»€ä¹ˆæ˜¯é•œåƒï¼Ÿ

é•œåƒæ˜¯ä¸€ä¸ª**åªè¯»çš„æ¨¡æ¿**ï¼ŒåŒ…å«äº†è¿è¡Œåº”ç”¨æ‰€éœ€çš„ä¸€åˆ‡ï¼š
- æ“ä½œç³»ç»ŸåŸºç¡€å±‚
- åº”ç”¨ç¨‹åºä»£ç 
- è¿è¡Œæ—¶ä¾èµ–
- é…ç½®æ–‡ä»¶

å¯ä»¥æŠŠé•œåƒç†è§£ä¸º"å®‰è£…åŒ…"æˆ–"å¿«ç…§"ã€‚

### å¸¸ç”¨é•œåƒå‘½ä»¤

```bash
# æŸ¥çœ‹æœ¬åœ°æ‰€æœ‰é•œåƒ
docker images

# æ‹‰å–é•œåƒ (ä» Docker Hub)
docker pull nginx:1.25.1

# åˆ é™¤é•œåƒ
docker rmi nginx:1.25.1

# æŸ¥çœ‹é•œåƒè¯¦æƒ…
docker inspect nginx:1.25.1
```

### é•œåƒå‘½åè§„åˆ™

```
[ä»“åº“åœ°å€/]ä»“åº“å:æ ‡ç­¾

ä¾‹å¦‚ï¼š
nginx:1.25.1          â† å®˜æ–¹é•œåƒï¼Œç‰ˆæœ¬ 1.25.1
pgvector/pgvector:pg16 â† ç¬¬ä¸‰æ–¹é•œåƒ
my-app:latest         â† è‡ªå®šä¹‰é•œåƒï¼Œlatest æ ‡ç­¾
```

---

## ğŸ“¦ å®¹å™¨ (Container)

### ä»€ä¹ˆæ˜¯å®¹å™¨ï¼Ÿ

å®¹å™¨æ˜¯é•œåƒçš„**è¿è¡Œå®ä¾‹**ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§ã€éš”ç¦»çš„è¿è¡Œç¯å¢ƒã€‚

```
é•œåƒ (Image)  â†’  å¯åŠ¨  â†’  å®¹å™¨ (Container)
   åªè¯»              å¯è¯»å†™ï¼Œå¯è¿è¡Œ
```

ç±»æ¯”ï¼š
- é•œåƒ = ç±» (Class)
- å®¹å™¨ = å¯¹è±¡ (Object)

### å¸¸ç”¨å®¹å™¨å‘½ä»¤

```bash
# è¿è¡Œå®¹å™¨
docker run -d --name my-nginx -p 8080:80 nginx:1.25.1
#   -d           åå°è¿è¡Œ
#   --name       æŒ‡å®šå®¹å™¨åç§°
#   -p 8080:80   ç«¯å£æ˜ å°„ï¼ˆä¸»æœº:å®¹å™¨ï¼‰

# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬åœæ­¢çš„ï¼‰
docker ps -a

# åœæ­¢å®¹å™¨
docker stop my-nginx

# å¯åŠ¨å·²åœæ­¢çš„å®¹å™¨
docker start my-nginx

# åˆ é™¤å®¹å™¨ï¼ˆå¿…é¡»å…ˆåœæ­¢ï¼‰
docker rm my-nginx

# è¿›å…¥å®¹å™¨å†…éƒ¨
docker exec -it my-nginx /bin/bash
#   -it  äº¤äº’å¼ç»ˆç«¯

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs my-nginx
docker logs -f my-nginx   # æŒç»­è·Ÿè¸ªæ—¥å¿—
```

### å®¹å™¨ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»º (Created) â†’ è¿è¡Œ (Running) â†’ æš‚åœ (Paused)
                      â†“
                 åœæ­¢ (Stopped) â†’ åˆ é™¤ (Removed)
```

---

## ğŸŒ Docker ç½‘ç»œ

### ç½‘ç»œç±»å‹

| ç±»å‹ | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `bridge` | é»˜è®¤ï¼Œå®¹å™¨é—´éš”ç¦» | å•æœºå¤šå®¹å™¨é€šä¿¡ |
| `host` | ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œ | æ€§èƒ½æ•æ„Ÿåœºæ™¯ |
| `none` | æ— ç½‘ç»œ | å®‰å…¨éš”ç¦» |
| `è‡ªå®šä¹‰ bridge` | æ¨èï¼Œå®¹å™¨é—´å¯æŒ‰åç§°é€šä¿¡ | æœ¬é¡¹ç›®ä½¿ç”¨ |

### ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰ç½‘ç»œï¼Ÿ

åœ¨**é»˜è®¤ bridge ç½‘ç»œ**ä¸­ï¼Œå®¹å™¨é—´åªèƒ½é€šè¿‡ IP é€šä¿¡ã€‚
åœ¨**è‡ªå®šä¹‰ bridge ç½‘ç»œ**ä¸­ï¼Œå®¹å™¨é—´å¯é€šè¿‡**å®¹å™¨åç§°**ç›´æ¥é€šä¿¡ã€‚

```bash
# åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ
docker network create binghe-network

# æŸ¥çœ‹ç°æœ‰ç½‘ç»œ
docker network ls

# å°†å®¹å™¨è¿æ¥åˆ°ç½‘ç»œ
docker network connect binghe-network my-container

# æŸ¥çœ‹ç½‘ç»œä¸­çš„å®¹å™¨
docker network inspect binghe-network
```

### æœ¬é¡¹ç›®ç½‘ç»œæ¶æ„

```
                    binghe-network (è‡ªå®šä¹‰ bridge)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  nginx â†â”€â”€â†’ ai-rag-knowledge-app â†â”€â”€â†’ vector_db           â”‚
â”‚                   â†“         â†“                               â”‚
â”‚               redis      ollama                             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¹å™¨é—´é€šè¿‡åç§°è®¿é—®ï¼Œä¾‹å¦‚ï¼š
- åº”ç”¨è¿æ¥æ•°æ®åº“ï¼šjdbc:postgresql://vector_db:5432/ai-rag-knowledge
- åº”ç”¨è¿æ¥ Redisï¼šredis:6379
- Nginx ä»£ç†è¯·æ±‚ï¼šhttp://ai-rag-knowledge-app:8090
```

---

## ğŸ’¾ æ•°æ®æŒä¹…åŒ–

### ä¸ºä»€ä¹ˆéœ€è¦æŒä¹…åŒ–ï¼Ÿ

å®¹å™¨é»˜è®¤æ˜¯**ä¸´æ—¶çš„**ï¼Œåˆ é™¤å®¹å™¨åæ•°æ®ä¼šä¸¢å¤±ã€‚è¦ä¿ç•™æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨**å· (Volume)** æˆ–**æŒ‚è½½ (Bind Mount)**ã€‚

### ä¸¤ç§æ–¹å¼è¯¦è§£

#### Volumeï¼ˆDocker ç®¡ç†çš„å­˜å‚¨ï¼‰

```bash
# åˆ›å»ºå‘½åå·
docker volume create my-data

# ä½¿ç”¨å‘½åå·
docker run -v my-data:/var/lib/postgresql/data postgres

# æŸ¥çœ‹å·åˆ—è¡¨
docker volume ls

# æŸ¥çœ‹å·è¯¦æƒ…ï¼ˆåŒ…æ‹¬å­˜å‚¨ä½ç½®ï¼‰
docker volume inspect my-data
```

**ç‰¹ç‚¹**ï¼š
- æ•°æ®å­˜å‚¨åœ¨ Docker å†…éƒ¨ç›®å½•ï¼ˆLinux: `/var/lib/docker/volumes/`ï¼‰
- ç”± Docker å®Œå…¨ç®¡ç†ï¼Œç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºå®¹å™¨
- **macOS/Windows ä¸Šæ€§èƒ½æ›´å¥½**ï¼ˆå…³é”®å·®å¼‚ï¼ï¼‰
- å¯é€šè¿‡ volume driver æ‰©å±•åˆ°äº‘å­˜å‚¨

#### Bind Mountï¼ˆæŒ‚è½½å®¿ä¸»æœºç›®å½•ï¼‰

**è¯­æ³•æ ¼å¼**ï¼šå†’å·åˆ†éš”ï¼Œ**å·¦è¾¹å®¿ä¸»æœºï¼Œå³è¾¹å®¹å™¨**

```
/Users/xiexu/logs:/app/data/log
        â†‘                â†‘
     å®¿ä¸»æœºè·¯å¾„       å®¹å™¨å†…è·¯å¾„
```

è®°å¿†å£è¯€ï¼š`å®¿ä¸»æœº:å®¹å™¨` = `å¤–:å†…` = `å·¦:å³`

**å·¥ä½œåŸç†å›¾è§£**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¿ä¸»æœº (ä½ çš„ç”µè„‘)                      â”‚
â”‚                                                          â”‚
â”‚   /Users/xiexu/logs/  â†â”€â”€ æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨è¿™é‡Œ              â”‚
â”‚           â”‚                                              â”‚
â”‚           â”‚ æŒ‚è½½æ˜ å°„                                      â”‚
â”‚           â†“                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                 Docker å®¹å™¨                     â”‚     â”‚
â”‚   â”‚                                                â”‚     â”‚
â”‚   â”‚   /app/data/log/  â†â”€â”€ åº”ç”¨å¾€è¿™é‡Œå†™æ—¥å¿—           â”‚     â”‚
â”‚   â”‚                                                â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¹å™¨å†™å…¥ /app/data/log/app.log
  â†“ è‡ªåŠ¨åŒæ­¥
å®¿ä¸»æœº /Users/xiexu/logs/app.log å¯è§
```

**å‘½ä»¤ç¤ºä¾‹**ï¼š

```bash
# æŒ‚è½½å®¿ä¸»æœºç›®å½•
docker run -v /home/user/data:/var/lib/postgresql/data postgres

# ä½¿ç”¨å½“å‰ç›®å½•
docker run -v $(pwd)/data:/app/data my-app
```

**ç‰¹ç‚¹**ï¼š
- æ•°æ®å­˜å‚¨åœ¨ä½ æŒ‡å®šçš„å®¿ä¸»æœºç›®å½•ï¼Œä½ç½®é€æ˜
- å¤–éƒ¨å¤‡ä»½å·¥å…·ï¼ˆrsyncã€tarï¼‰å¯ç›´æ¥è®¿é—®
- æ›´ç¬¦åˆä¼ ç»Ÿè¿ç»´ä¹ æƒ¯
- **Linux ä¸Šæ€§èƒ½ä¸ Volume ç›¸åŒ**

### è¯¦ç»†å¯¹æ¯”

| ç‰¹æ€§ | Volume | Bind Mount |
|------|--------|------------|
| **æ•°æ®ä½ç½®** | Docker å†…éƒ¨ç®¡ç† | ä½ æŒ‡å®šçš„å®¿ä¸»æœºè·¯å¾„ |
| **å¯è§æ€§** | éœ€è¦ `docker volume inspect` æŸ¥çœ‹ | ç›´æ¥åœ¨æ–‡ä»¶ç³»ç»Ÿå¯è§ |
| **è·¨å¹³å°æ€§èƒ½** | âœ… macOS/Windows æ€§èƒ½å¥½ | âš ï¸ macOS/Windows æ€§èƒ½å·® |
| **Linux æ€§èƒ½** | ç›¸åŒ | ç›¸åŒ |
| **å¤–éƒ¨å·¥å…·è®¿é—®** | ä¸ä¾¿ | æ–¹ä¾¿ï¼ˆrsyncã€å¤‡ä»½ç­‰ï¼‰ |
| **æƒé™ç®¡ç†** | Docker è‡ªåŠ¨å¤„ç† | éœ€æ‰‹åŠ¨é…ç½® |
| **è¿ç§»å¤‡ä»½** | `docker volume` å‘½ä»¤ | æ ‡å‡†æ–‡ä»¶æ“ä½œ |

### ä¸ºä»€ä¹ˆ macOS/Windows ä¸Šæœ‰æ€§èƒ½å·®å¼‚ï¼Ÿ

åœ¨ **macOS/Windows** ä¸Šï¼ŒDocker Desktop è¿è¡Œåœ¨ Linux è™šæ‹Ÿæœºä¸­ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               macOS/Windows å®¿ä¸»æœº              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Docker Desktop (è™šæ‹Ÿæœº)          â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚         Linux å†…æ ¸                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚    Volume     â”‚ â”‚  å®¹å™¨       â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ (Linux åŸç”Ÿ)  â”‚ â”‚             â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚              â†‘ æ–‡ä»¶ç³»ç»Ÿè½¬æ¢å±‚ï¼ˆæ…¢ï¼‰         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                 â†“                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     Bind Mount ç›®å½•ï¼ˆå®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿï¼‰       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Volume**ï¼šæ•°æ®ä¿å­˜åœ¨è™šæ‹Ÿæœºçš„ Linux æ–‡ä»¶ç³»ç»Ÿå†…ï¼Œæ— éœ€è½¬æ¢ï¼ŒåŸç”Ÿæ€§èƒ½
- **Bind Mount**ï¼šéœ€è¦ç»è¿‡ gRPC-FUSE ç­‰æ–‡ä»¶ç³»ç»Ÿè½¬æ¢å±‚ï¼Œ**æ€§èƒ½æŸå¤± 10-100 å€**

### åœºæ™¯æ¨è

| åœºæ™¯ | æ¨èæ–¹å¼ | åŸå›  |
|------|----------|------|
| macOS/Windows æœ¬åœ°å¼€å‘çš„æ•°æ®åº“ | **Volume** | æ€§èƒ½å·®å¼‚æ˜æ˜¾ |
| Linux æœåŠ¡å™¨/ç”Ÿäº§ç¯å¢ƒçš„æ•°æ®åº“ | **Bind Mount** | ä¾¿äºå¤‡ä»½å’Œè¿ç»´ |
| é…ç½®æ–‡ä»¶ã€å‰ç«¯é™æ€èµ„æº | **Bind Mount** | éœ€è¦é¢‘ç¹ä¿®æ”¹ |
| æ—¥å¿—æ–‡ä»¶ | **Bind Mount** | ä¾¿äºå¤–éƒ¨å·¥å…·åˆ†æ |
| å¼€å‘è°ƒè¯•æ—¶çš„æºä»£ç  | **Bind Mount** | éœ€è¦å®æ—¶åŒæ­¥ |

### æœ¬é¡¹ç›®æŒ‚è½½é…ç½®

```yaml
# docker-compose.yml ä¸­çš„æŒ‚è½½é…ç½®

# ========== ç¬¬ä¸€æ­¥ï¼šé¡¶å±‚å£°æ˜å‘½åå· ==========
# åªæœ‰ Volume éœ€è¦å£°æ˜ï¼ŒBind Mount ä¸éœ€è¦
volumes:
  pgvector-data:    # å£°æ˜ä¸€ä¸ªåå« pgvector-data çš„ Volume

# ========== ç¬¬äºŒæ­¥ï¼šåœ¨æœåŠ¡ä¸­ä½¿ç”¨ ==========
services:
  # ä½¿ç”¨ Volumeï¼ˆå‘½åå·ï¼‰
  vector_db:
    volumes:
      - pgvector-data:/var/lib/postgresql/data
      #     â†‘ å¼•ç”¨ä¸Šé¢å£°æ˜çš„å‘½åå·

  # ä½¿ç”¨ Bind Mountï¼ˆç›´æ¥æŒ‚è½½å®¿ä¸»æœºç›®å½•ï¼Œä¸éœ€è¦é¡¶å±‚å£°æ˜ï¼‰
  ai-rag-knowledge-app:
    volumes:
      - /Users/xiexu/logs:/app/data/log          # ç»å¯¹è·¯å¾„ â†’ Bind Mount

  nginx:
    volumes:
      - ./frontend:/usr/share/nginx/html         # ç›¸å¯¹è·¯å¾„ â†’ Bind Mount
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf # ç›¸å¯¹è·¯å¾„ â†’ Bind Mount
      - ./certs:/etc/nginx/certs                 # ç›¸å¯¹è·¯å¾„ â†’ Bind Mount
```

> âš ï¸ **æ³¨æ„**ï¼šè™½ç„¶å­¦ä¹ æ—¶æˆ‘ä»¬å…ˆè®²"å£°æ˜"å†è®²"ä½¿ç”¨"ï¼Œä½†åœ¨å®é™…çš„ docker-compose.yml æ–‡ä»¶ä¸­ï¼Œ
> ä¹ æƒ¯ä¸Š `services:` å†™åœ¨å‰é¢ï¼Œ`volumes:` å†™åœ¨åé¢ã€‚Docker ä¼šå…ˆè§£ææ•´ä¸ªæ–‡ä»¶å†æ‰§è¡Œï¼Œæ‰€ä»¥é¡ºåºä¸å½±å“åŠŸèƒ½ã€‚

**å¿«é€Ÿåˆ¤æ–­æ–¹æ³•ï¼ˆçœ‹å†’å·å·¦è¾¹ï¼‰**ï¼š

```
pgvector-data:/var/lib/...     â† å·¦è¾¹æ˜¯å·å â†’ Volume
/Users/xiexu/logs:/app/...     â† å·¦è¾¹æ˜¯ç»å¯¹è·¯å¾„ â†’ Bind Mount
./frontend:/usr/share/...      â† å·¦è¾¹æ˜¯ç›¸å¯¹è·¯å¾„ â†’ Bind Mount
```

- å†’å·å·¦è¾¹ä»¥ `/` æˆ– `./` å¼€å¤´ â†’ **Bind Mount**
- å†’å·å·¦è¾¹åªæ˜¯åç§° â†’ **Volume**

> ğŸ’¡ **æ€»ç»“**ï¼šæ²¡æœ‰ç»å¯¹çš„"æœ€ä½³å®è·µ"ï¼Œæ ¹æ®ä½ çš„**å¹³å°**å’Œ**ä½¿ç”¨åœºæ™¯**é€‰æ‹©åˆé€‚çš„æ–¹å¼ã€‚

---

## ğŸ¼ Docker Compose

### ä»€ä¹ˆæ˜¯ Docker Composeï¼Ÿ

Docker Compose æ˜¯ç”¨äºå®šä¹‰å’Œè¿è¡Œ**å¤šå®¹å™¨åº”ç”¨**çš„å·¥å…·ã€‚é€šè¿‡ä¸€ä¸ª YAML æ–‡ä»¶æè¿°æ‰€æœ‰æœåŠ¡ï¼Œä¸€æ¡å‘½ä»¤å¯åŠ¨/åœæ­¢æ•´ä¸ªåº”ç”¨æ ˆã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ Composeï¼Ÿ

æ‰‹åŠ¨ç®¡ç†å¤šä¸ªå®¹å™¨éå¸¸ç¹çï¼š

```bash
# æ‰‹åŠ¨æ–¹å¼ï¼šéœ€è¦ä¾æ¬¡æ‰§è¡Œå¤šæ¡å‘½ä»¤
docker run -d --name postgres ...
docker run -d --name redis ...
docker run -d --name ollama ...
docker run -d --name app --link postgres --link redis ...
docker run -d --name nginx --link app ...
```

ä½¿ç”¨ Composeï¼š

```bash
# ä¸€æ¡å‘½ä»¤å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# ä¸€æ¡å‘½ä»¤åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose down
```

### docker-compose.yml åŸºæœ¬ç»“æ„

```yaml
version: '3.8'

services:
  # æœåŠ¡å®šä¹‰
  nginx:
    image: nginx:1.25.1        # ä½¿ç”¨çš„é•œåƒ
    container_name: nginx      # å®¹å™¨åç§°
    ports:
      - "80:80"                # ç«¯å£æ˜ å°„
    volumes:
      - ./frontend:/usr/share/nginx/html  # ç›®å½•æŒ‚è½½
    depends_on:
      - app                    # ä¾èµ–çš„æœåŠ¡ï¼ˆè§ä¸‹æ–¹è¯´æ˜ï¼‰
    networks:
      - binghe-network         # åŠ å…¥çš„ç½‘ç»œ

  app:
    build:
      context: ./app           # æ„å»ºä¸Šä¸‹æ–‡
      dockerfile: Dockerfile   # Dockerfile ä½ç½®
    environment:
      - DATABASE_URL=...       # ç¯å¢ƒå˜é‡
    networks:
      - binghe-network

networks:
  binghe-network:
    external: true             # ä½¿ç”¨å¤–éƒ¨å·²å­˜åœ¨çš„ç½‘ç»œ
```

### depends_onï¼šæœåŠ¡å¯åŠ¨é¡ºåº

`depends_on` ç”¨äºæ§åˆ¶æœåŠ¡çš„**å¯åŠ¨é¡ºåº**ï¼š

```yaml
nginx:
  depends_on:
    - app    # nginx ä¾èµ– appï¼Œæ‰€ä»¥ app å…ˆå¯åŠ¨
```

**å¯åŠ¨é¡ºåºå›¾è§£**ï¼š

```
å¯åŠ¨ï¼šapp (åç«¯) â”€â”€â”€å…ˆâ”€â”€â”€â–¶ nginx (å‰ç«¯)
åœæ­¢ï¼šnginx (å‰ç«¯) â”€â”€â”€å…ˆâ”€â”€â”€â–¶ app (åç«¯)  # åœæ­¢æ—¶é¡ºåºç›¸å
```

**ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ**
- Nginx éœ€è¦æŠŠ `/api/*` ä»£ç†åˆ°åç«¯
- å¦‚æœåç«¯æ²¡å¯åŠ¨ï¼Œåå‘ä»£ç†ä¼šå¤±è´¥

### âš ï¸ depends_on çš„å±€é™æ€§

`depends_on` åªä¿è¯**å®¹å™¨å¯åŠ¨é¡ºåº**ï¼Œä¸ä¿è¯æœåŠ¡**å®Œå…¨å°±ç»ª**ï¼š

```
app å®¹å™¨å¯åŠ¨ â‰  Spring Boot åº”ç”¨å¯ç”¨
```

Spring Boot å¯èƒ½éœ€è¦ 30-60 ç§’åˆå§‹åŒ–ï¼Œå®¹å™¨æ—©å°±"å¯åŠ¨"äº†ï¼Œä½†åº”ç”¨è¿˜æ²¡å‡†å¤‡å¥½ã€‚

### healthcheckï¼šç­‰å¾…æœåŠ¡çœŸæ­£å°±ç»ª

é…åˆ `healthcheck` å’Œ `condition` å¯ä»¥å®ç°**ç­‰å¾…æœåŠ¡å°±ç»ª**ï¼š

```yaml
services:
  app:
    image: my-app:1.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/actuator/health"]
      interval: 30s       # æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
      timeout: 10s        # è¶…æ—¶æ—¶é—´
      retries: 3          # å¤±è´¥é‡è¯•æ¬¡æ•°
      start_period: 60s   # å¯åŠ¨ç­‰å¾…æœŸï¼ˆç»™åº”ç”¨ 60 ç§’å¯åŠ¨æ—¶é—´ï¼‰

  nginx:
    image: nginx:1.25.1
    depends_on:
      app:
        condition: service_healthy  # ç­‰ app å¥åº·æ£€æŸ¥é€šè¿‡å†å¯åŠ¨ nginx
```

**æ•ˆæœ**ï¼š
```
app å®¹å™¨å¯åŠ¨ â†’ ç­‰å¾… healthcheck é€šè¿‡ â†’ nginx å®¹å™¨å¯åŠ¨
                     â†‘
              æœ€å¤šç­‰ 60 ç§’ (start_period)
```

### å¸¸ç”¨ Compose å‘½ä»¤

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
docker compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose down

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker compose logs
docker compose logs -f nginx    # è·Ÿè¸ªæŒ‡å®šæœåŠ¡æ—¥å¿—

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker compose up -d --build

# åªå¯åŠ¨ç‰¹å®šæœåŠ¡
docker compose up -d nginx app
```

---

## ğŸ“Š æ¦‚å¿µå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Docker Engine                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¯åŠ¨    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚   é•œåƒ      â”‚  â”€â”€â”€â”€â”€â”€â”€â–¶  â”‚   å®¹å™¨      â”‚                 â”‚
â”‚  â”‚  (Image)    â”‚            â”‚ (Container) â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                    â”‚                         â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                 â”‚                  â”‚                  â”‚      â”‚
â”‚                 â–¼                  â–¼                  â–¼      â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚          â”‚  ç½‘ç»œ    â”‚       â”‚   å·     â”‚      â”‚   ç«¯å£   â”‚  â”‚
â”‚          â”‚ Network  â”‚       â”‚ Volume   â”‚      â”‚   Port   â”‚  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Docker Composeï¼šå®šä¹‰å’Œç®¡ç†å¤šä¸ªæœåŠ¡çš„ç¼–æ’å·¥å…·                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… æœ¬ç« æ£€æŸ¥æ¸…å•

åœ¨è¿›å…¥ä¸‹ä¸€ç« ä¹‹å‰ï¼Œè¯·ç¡®ä¿ç†è§£ï¼š

- [ ] é•œåƒå’Œå®¹å™¨çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
- [ ] è‡ªå®šä¹‰ç½‘ç»œç›¸æ¯”é»˜è®¤ç½‘ç»œæœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ
- [ ] Volume å’Œ Bind Mount åˆ†åˆ«é€‚ç”¨äºä»€ä¹ˆåœºæ™¯ï¼Ÿ
- [ ] Docker Compose è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

| ä¸Šä¸€ç¯‡ | ä¸‹ä¸€ç¯‡ |
|--------|--------|
| [01-ç¯å¢ƒå‡†å¤‡](./01-ç¯å¢ƒå‡†å¤‡.md) | [03-AI åŸºç¡€çŸ¥è¯†](./03-AIåŸºç¡€çŸ¥è¯†.md) |

[è¿”å›ç›®å½•](./README.md)
