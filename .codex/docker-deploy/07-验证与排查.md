# 06 - 验证与排查

> 本章介绍如何验证部署是否成功，以及常见问题的排查方法。

---

## 📋 本章目标

完成本章后，你将能够：
- ✅ 验证所有服务正常运行
- ✅ 使用健康检查端点监控状态
- ✅ 排查常见部署问题
- ✅ 查看和分析日志

---

## ✅ 一键验证脚本

将以下脚本保存并执行，快速检查所有服务状态：

```bash
#!/bin/bash
# 文件名: check-deployment.sh

echo "🔍 AI-RAG-Knowledge 部署验证"
echo "=============================="
echo ""

# 检查函数
check_service() {
    local name=$1
    local cmd=$2
    local expected=$3

    printf "%-25s" "检查 $name..."
    result=$(eval "$cmd" 2>/dev/null)
    if echo "$result" | grep -q "$expected"; then
        echo "✅ 正常"
        return 0
    else
        echo "❌ 异常"
        return 1
    fi
}

# 中间件检查
echo "📦 中间件服务"
echo "--------------"
check_service "PostgreSQL" "docker exec vector_db psql -U postgres -c 'SELECT 1'" "1"
check_service "pgvector 扩展" "docker exec vector_db psql -U postgres -d ai-rag-knowledge -c \"SELECT extname FROM pg_extension WHERE extname='vector'\"" "vector"
check_service "Redis" "docker exec redis redis-cli ping" "PONG"
check_service "Ollama" "curl -s http://localhost:11434/api/version" "version"

echo ""

# 应用检查
echo "🚀 应用服务"
echo "--------------"
check_service "后端健康检查" "curl -s http://localhost:8090/actuator/health" "UP"
check_service "Nginx HTTPS" "curl -sk https://localhost/" "html"
check_service "HTTP 重定向" "curl -sI http://localhost | head -1" "301"

echo ""

# 容器状态
echo "🐳 容器状态"
echo "--------------"
docker ps --format "table {{.Names}}\t{{.Status}}" | grep -E "nginx|ai-rag|vector_db|redis|ollama"

echo ""

# 网络检查
echo "🌐 网络连接"
echo "--------------"
containers=$(docker network inspect binghe-network --format '{{range .Containers}}{{.Name}} {{end}}' 2>/dev/null)
echo "binghe-network 容器: $containers"

echo ""
echo "=============================="
echo "验证完成！"
```

---

## 🔍 逐项验证

### 1. 中间件服务验证

#### PostgreSQL

```bash
# 检查容器运行
docker ps | grep vector_db

# 测试连接
docker exec vector_db psql -U postgres -c "SELECT version();"

# 检查数据库存在
docker exec vector_db psql -U postgres -c "\l" | grep ai-rag-knowledge

# 检查 pgvector 扩展
docker exec vector_db psql -U postgres -d ai-rag-knowledge -c \
  "SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';"
```

#### Redis

```bash
# 检查容器运行
docker ps | grep redis

# 测试连接
docker exec redis redis-cli ping
# 预期输出：PONG

# 检查信息
docker exec redis redis-cli info server | head -5
```

#### Ollama

```bash
# 检查容器运行
docker ps | grep ollama

# 检查 API
curl http://localhost:11434/api/version

# 查看已下载模型
docker exec ollama ollama list
```

### 2. 应用服务验证

#### 后端 API

```bash
# 健康检查端点
curl http://localhost:8090/actuator/health
# 预期：{"status":"UP","components":{...}}

# 详细健康信息
curl http://localhost:8090/actuator/health | jq
```

#### Nginx

```bash
# 检查容器运行
docker ps | grep nginx

# HTTPS 访问测试（-k 忽略证书警告）
curl -k https://localhost/

# HTTP 重定向测试
curl -I http://localhost
# 预期：HTTP/1.1 301 Moved Permanently

# 检查 API 代理
curl -k https://localhost/actuator/health
```

### 3. 网络连通性验证

```bash
# 检查容器是否在同一网络
docker network inspect binghe-network

# 测试容器间连通性
docker exec ai-rag-knowledge-app ping -c 3 vector_db
docker exec ai-rag-knowledge-app ping -c 3 redis
docker exec ai-rag-knowledge-app ping -c 3 ollama

# 从应用容器连接数据库
docker exec ai-rag-knowledge-app sh -c \
  "nc -zv vector_db 5432 && echo '数据库连接正常'"
```

---

## 🐛 常见问题排查

### 问题 1：容器启动失败

**现象**：`docker ps` 看不到容器或状态为 `Exited`

**排查步骤**：

```bash
# 查看所有容器（包括停止的）
docker ps -a

# 查看容器日志
docker logs ai-rag-knowledge-app

# 查看最后 50 行
docker logs --tail 50 ai-rag-knowledge-app
```

**常见原因与解决**：

| 原因 | 错误信息 | 解决方案 |
|------|----------|----------|
| 端口被占用 | `Bind for 0.0.0.0:8090 failed` | 更换端口或停止占用进程 |
| 镜像不存在 | `Unable to find image` | 执行 `docker compose build` |
| 网络不存在 | `network binghe-network not found` | 执行 `docker network create binghe-network` |

### 问题 2：应用无法连接数据库

**现象**：日志显示 `Connection refused` 或 `Could not connect`

**排查步骤**：

```bash
# 检查数据库容器是否运行
docker ps | grep vector_db

# 检查网络
docker network inspect binghe-network | grep -A 5 vector_db

# 检查数据库是否存在
docker exec vector_db psql -U postgres -c "\l"

# 从应用容器测试连接
docker exec ai-rag-knowledge-app sh -c \
  "apt-get update && apt-get install -y postgresql-client && \
   psql -h vector_db -U postgres -c 'SELECT 1'"
```

**解决方案**：

```bash
# 如果容器不在同一网络，手动连接
docker network connect binghe-network vector_db
docker network connect binghe-network ai-rag-knowledge-app

# 重启应用
docker restart ai-rag-knowledge-app
```

### 问题 3：Ollama 调用超时

**现象**：AI 对话功能无响应或超时

**排查步骤**：

```bash
# 检查 Ollama 容器
docker ps | grep ollama

# 查看 Ollama 日志
docker logs ollama

# 测试 Ollama API
curl http://localhost:11434/api/version

# 检查模型是否已下载
docker exec ollama ollama list

# 测试模型生成
curl http://localhost:11434/api/generate -d '{
  "model": "qwen2.5:0.5b",
  "prompt": "hello",
  "stream": false
}'
```

**解决方案**：

```bash
# 如果模型未下载
docker exec ollama ollama pull qwen2.5:0.5b

# 如果内存不足，使用更小的模型
docker exec ollama ollama pull qwen2.5:0.5b
```

### 问题 4：HTTPS 证书错误

**现象**：浏览器显示"连接不安全"或证书错误

**排查步骤**：

```bash
# 检查证书文件是否存在
ls -la .claude/docker-deploy/certs/

# 查看证书信息
openssl x509 -in .claude/docker-deploy/certs/localhost.crt -noout -text | head -20

# 检查 Nginx 日志
docker logs nginx | grep -i ssl
```

**解决方案**：

```bash
# 重新生成证书
rm -rf .claude/docker-deploy/certs/*
.claude/docker-deploy/scripts/gen-ssl-cert.sh

# 重启 Nginx
docker restart nginx
```

> 💡 **提示**：自签名证书始终会触发浏览器警告，这是正常的。点击"高级"→"继续访问"即可。

### 问题 5：静态资源 404

**现象**：访问前端页面显示 404 或空白

**排查步骤**：

```bash
# 检查前端文件是否存在
ls -la .claude/docker-deploy/frontend/

# 检查 Nginx 容器内文件
docker exec nginx ls -la /usr/share/nginx/html/

# 检查 Nginx 配置是否正确
docker exec nginx nginx -t
```

**解决方案**：

```bash
# 重新同步前端资源
cp -r xfg-dev-tech-app/src/main/resources/static/* .claude/docker-deploy/frontend/

# 重启 Nginx
docker restart nginx
```

### 问题 6：日志未写入宿主机

**现象**：`/Users/xiexu/logs/` 目录为空

**排查步骤**：

```bash
# 检查目录权限
ls -la /Users/xiexu/logs/

# 检查容器内日志目录
docker exec ai-rag-knowledge-app ls -la /app/data/log/

# 检查挂载配置
docker inspect ai-rag-knowledge-app | grep -A 10 Mounts
```

**解决方案**：

```bash
# 确保目录存在并有权限
mkdir -p /Users/xiexu/logs
chmod 755 /Users/xiexu/logs

# 重启容器
docker restart ai-rag-knowledge-app
```

---

## 📊 日志分析

### 查看容器日志

```bash
# 实时跟踪
docker logs -f ai-rag-knowledge-app

# 查看最近 100 行
docker logs --tail 100 ai-rag-knowledge-app

# 查看特定时间段
docker logs --since "2026-01-10T10:00:00" ai-rag-knowledge-app
```

### 查看宿主机日志

```bash
# 查看应用日志
tail -f /Users/xiexu/logs/*.log

# 搜索错误
grep -i "error\|exception" /Users/xiexu/logs/*.log

# 按时间筛选
grep "2026-01-10 16:" /Users/xiexu/logs/*.log
```

### 日志关键词速查

| 关键词 | 含义 | 可能原因 |
|--------|------|----------|
| `Connection refused` | 连接被拒绝 | 目标服务未启动 |
| `Connection reset` | 连接重置 | 网络问题或服务崩溃 |
| `No such host` | 找不到主机 | DNS 解析失败，检查网络 |
| `Timeout` | 超时 | 服务响应慢或网络问题 |
| `OutOfMemoryError` | 内存不足 | 增加 JVM 内存配置 |
| `Port already in use` | 端口被占用 | 停止占用进程或换端口 |

---

## 🔄 重置环境

如果需要完全重置并重新部署：

```bash
# 停止并删除所有相关容器
docker compose -f .claude/docker-deploy/docker-compose.yml down

# 删除应用镜像（可选）
docker rmi ai-rag-knowledge-app:1.0

# 清理悬空镜像和缓存
docker system prune -f

# 重新部署
.claude/docker-deploy/scripts/deploy.sh
```

> ⚠️ **注意**：中间件数据（数据库、Redis）存储在 Docker Volume 中，上述命令不会删除这些数据。如需清理，执行：
> ```bash
> docker volume rm pgvector-data redis-data ollama-data
> ```

---

## ✅ 部署完成检查清单

确保所有项目都已完成：

- [ ] `docker ps` 显示 5 个容器运行中 (nginx, app, vector_db, redis, ollama)
- [ ] PostgreSQL 可连接，ai-rag-knowledge 数据库存在
- [ ] pgvector 扩展已启用
- [ ] Redis 响应 PONG
- [ ] Ollama 至少有一个模型
- [ ] 后端 /actuator/health 返回 UP
- [ ] https://localhost 可正常访问
- [ ] API 请求可通过 Nginx 代理到后端
- [ ] 日志文件正确写入宿主机

---

## 🎉 恭喜完成！

你已经完成了整个 Docker 部署学习！现在你应该能够：

1. 在 macOS 或 Ubuntu 上安装 Docker
2. 理解 Docker 镜像、容器、网络、卷等核心概念
3. 部署 PostgreSQL、Redis、Ollama 中间件
4. 构建并部署 Spring Boot 应用
5. 配置 Nginx 反向代理和 HTTPS
6. 排查常见部署问题

### 后续学习建议

- 📚 [Docker 官方文档](https://docs.docker.com/)
- 📚 [Nginx 官方文档](https://nginx.org/en/docs/)
- 📚 [Spring Boot Docker 指南](https://spring.io/guides/topicals/spring-boot-docker/)
- 📚 [Ollama 模型库](https://ollama.ai/library)

---

> **有问题？** 查阅本章的问题排查部分，或检查服务日志获取更多信息。

---

## 📚 文档导航

| 上一篇 | 下一篇 |
|--------|--------|
| [06-Nginx 配置](./06-Nginx配置.md) | [08-项目功能介绍](./08-项目功能介绍.md) |

[返回目录](./README.md)
