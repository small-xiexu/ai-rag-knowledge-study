<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åŠ©æ‰‹ - æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ</title>
    <!-- Tailwind CSS -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Markdown & Highlight CDNs -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* èƒŒæ™¯æ¸å˜ */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* æ¯›ç»ç’ƒæ•ˆæœ */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .message-enter { animation: messageEnter 0.2s ease-out; }
        @keyframes messageEnter {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Markdown æ ·å¼è¦†ç›– */
        .prose pre { margin: 0; padding: 0; background: transparent; }
        .prose :where(code):not(:where([class~="not-prose"] *)) { color: inherit; font-weight: 500; }
        .prose :where(code):not(:where([class~="not-prose"] *))::before { content: ""; }
        .prose :where(code):not(:where([class~="not-prose"] *))::after { content: ""; }
        .prose p { margin-bottom: 0.5em; margin-top: 0.5em; }
        .prose ul, .prose ol { margin-bottom: 0.5em; margin-top: 0.5em; padding-left: 1.5em; }
        .prose li { margin: 0; }
        
        /* ä»£ç å—æ ·å¼ */
        .hljs-container { position: relative; border-radius: 0.5rem; overflow: hidden; margin: 0.5rem 0; background: #282c34; }
        .hljs-header { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.25rem 0.75rem; background: #21252b; color: #abb2bf; font-size: 0.75rem;
            border-bottom: 1px solid #181a1f;
        }
        .hljs-body { padding: 0.75rem; overflow-x: auto; }
        .hljs { background: transparent !important; padding: 0 !important; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen py-8 px-4 overflow-hidden">
    <!-- é€šç”¨æ¨¡æ€æç¤º -->
    <div id="modalAlert" class="hidden fixed inset-0 z-[9999] flex items-center justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="hideModalAlert()"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
            <div class="px-6 py-4 bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                <h3 id="modalAlertTitle" class="text-lg font-semibold">æç¤º</h3>
            </div>
            <div class="p-6 space-y-3">
                <p id="modalAlertMessage" class="text-sm text-gray-700 leading-relaxed"></p>
            </div>
            <div class="px-6 pb-6 flex justify-end">
                <button id="modalAlertConfirm" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-xl hover:from-indigo-600 hover:to-purple-600 transition-all shadow">
                    ç¡®å®š
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»å¡ç‰‡ -->
    <div class="glass-card flex w-full max-w-7xl h-[90vh] rounded-3xl overflow-hidden shadow-2xl relative">
        <!-- ä¾§è¾¹æ  -->
        <aside id="sidebar" class="w-64 bg-gray-50/50 border-r border-gray-100 flex flex-col backdrop-blur-sm">
            <!-- Logo -->
            <div class="h-16 px-6 flex items-center border-b border-gray-100/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-md">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                        </svg>
                    </div>
                    <span class="font-bold text-lg text-gray-800 tracking-tight">AI Assistant</span>
                </div>
            </div>
            
            <!-- æ–°å»ºæŒ‰é’® + æ¸…ç©ºæŒ‰é’® -->
            <div class="p-4 space-y-2">
                <button onclick="createNewChat()" class="w-full py-2.5 bg-gradient-to-r from-gray-800 to-gray-900 hover:from-black hover:to-gray-800 text-white text-sm font-medium rounded-xl transition-all shadow-lg hover:shadow-xl flex items-center justify-center gap-2 group">
                    <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    æ–°å»ºå¯¹è¯
                </button>
                <button onclick="clearAllChats()" class="w-full py-2 bg-red-50 hover:bg-red-100 text-red-500 hover:text-red-600 text-xs font-medium rounded-xl transition-all flex items-center justify-center gap-1.5 border border-red-100 hover:border-red-200">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    æ¸…ç©ºæ‰€æœ‰å¯¹è¯
                </button>
            </div>
            
            <!-- èŠå¤©åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto px-3 space-y-1" id="chatList"></div>
            
            <!-- åº•éƒ¨ -->
            <div class="p-4 border-t border-gray-100/50 space-y-3 bg-white/30 backdrop-blur-sm">
                <!-- çŸ¥è¯†åº“å…¥å£ -->
                <a href="knowledge.html" class="w-full py-2 bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white text-xs font-semibold rounded-xl transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    ç®¡ç†çŸ¥è¯†åº“
                </a>
                
                <!-- æ¨¡å‹é…ç½®å…¥å£ -->
                <a href="model-config.html" class="w-full py-2 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white text-xs font-semibold rounded-xl transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    æ¨¡å‹é…ç½®
                </a>
                
                <div class="space-y-3 pt-2">
                    <!-- é…ç½®é€‰æ‹© -->
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-1">å½“å‰é…ç½® (å…¨å±€)</label>
                        <select id="configSelect" onchange="switchConfig()" class="w-full h-9 px-3 text-xs font-medium bg-green-50/50 border border-green-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/20 focus:border-green-300 text-green-700 transition-all cursor-pointer hover:bg-green-50">
                            <option value="" disabled selected>åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    
                    <div class="space-y-1.5">
                        <div class="flex items-center justify-between px-1">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">RAG çŸ¥è¯†åº“</label>
                            <span id="ragTagCount" class="text-[10px] text-purple-500 font-medium">0/10</span>
                        </div>
                        <!-- å·²é€‰æ ‡ç­¾åŒº -->
                        <div id="selectedRagTags" class="flex flex-wrap gap-1.5 min-h-[32px] p-2 bg-purple-50/50 border border-purple-100 rounded-lg">
                            <span class="text-[10px] text-gray-400 italic">æœªé€‰æ‹©çŸ¥è¯†åº“</span>
                        </div>
                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="flex items-center gap-2">
                            <button onclick="openRagTagSelector()" id="addRagTagBtn" class="flex-1 py-1.5 text-[10px] font-medium text-purple-600 bg-purple-100 hover:bg-purple-200 rounded-lg transition-colors flex items-center justify-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                æ·»åŠ 
                            </button>
                            <button onclick="selectAllRagTags()" class="py-1.5 px-2 text-[10px] font-medium text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">å…¨é€‰</button>
                            <button onclick="clearAllRagTags()" class="py-1.5 px-2 text-[10px] font-medium text-gray-500 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">æ¸…ç©º</button>
                        </div>
                    </div>
                    
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wider px-1">AI æ¨¡å‹</label>
                        <select id="modelSelect" onchange="onModelChange()" class="w-full h-9 px-3 text-xs font-medium bg-white/50 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-300 text-gray-700 transition-all cursor-pointer hover:bg-white">
                            <option value="" disabled selected>è¯·å…ˆé€‰æ‹©é…ç½®</option>
                        </select>
                    </div>
                </div>
            </div>
        </aside>

        <!-- ä¸»åŒºåŸŸ -->
        <main class="flex-1 flex flex-col bg-white/60 relative">
            <!-- å¤´éƒ¨ -->
            <header class="h-16 px-6 flex items-center justify-between border-b border-gray-100/50 bg-white/40 backdrop-blur-sm z-10">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden w-8 h-8 flex items-center justify-center hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                    </button>
                    <div>
                        <h1 id="currentChatTitle" class="text-lg font-bold text-gray-800">æ–°å¯¹è¯</h1>
                        <p class="text-xs text-gray-500 mt-0.5" id="chatStatus">AI åŠ©æ‰‹å‡†å¤‡å°±ç»ª</p>
                    </div>
                </div>
            </header>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div id="messagesContainer" class="flex-1 overflow-y-auto scroll-smooth">
                <!-- æ¬¢è¿é¡µ -->
                <div id="welcomeMessage" class="h-full flex flex-col items-center justify-center px-4">
                    <div class="w-20 h-20 rounded-3xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-8 shadow-xl shadow-indigo-500/20 animate-float">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-3">ä½ å¥½ï¼Œæˆ‘æ˜¯ä½ çš„ AI åŠ©æ‰‹</h2>
                    <p class="text-gray-500 text-base max-w-md text-center leading-relaxed">
                        åŸºäº RAG çŸ¥è¯†åº“å¢å¼ºçš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ<br>
                        é€‰æ‹©å·¦ä¾§çŸ¥è¯†åº“å’Œæ¨¡å‹ï¼Œå¼€å§‹æˆ‘ä»¬çš„å¯¹è¯å§
                    </p>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="px-6 py-6 bg-white/40 backdrop-blur-sm border-t border-gray-100/50">
                <div class="flex gap-4 items-center max-w-2xl mx-auto">
                    <div class="flex-1 relative group flex items-center">
                        <textarea 
                            id="messageInput" 
                            placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ä¸‹ Enter å‘é€..." 
                            rows="1"
                            class="w-full min-h-[56px] max-h-32 px-5 py-4 bg-white border border-gray-200 rounded-2xl resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 transition-all text-sm leading-relaxed overflow-hidden"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>
                    <button 
                        id="sendButton"
                        onclick="sendMessage()" 
                        class="w-14 h-14 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-2xl transition-all shadow-lg hover:shadow-indigo-500/30 flex items-center justify-center flex-shrink-0 active:scale-95"
                    >
                        <svg id="sendIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                        <svg id="loadingIcon" class="w-6 h-6 animate-spin hidden" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </button>
                </div>
                <p class="text-center text-xs text-gray-400 mt-3 font-medium">AI æ¨¡å‹ç”Ÿæˆå†…å®¹ä»…ä¾›å‚è€ƒ</p>
            </div>
        </main>
    </div>

    <!-- å³é”®èœå• -->
    <div id="contextMenu" class="hidden fixed bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-50 min-w-[140px]">
        <button onclick="renameChat()" class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2 text-sm text-gray-700">
            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            é‡å‘½å
        </button>
        <button onclick="deleteChat()" class="w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2 text-sm text-red-500">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            åˆ é™¤
        </button>
    </div>

    <script>
        let chats = [];
        let currentChatId = null;
        let isGenerating = false;
        let currentEventSource = null;
        let contextMenuChatId = null;
        let modelLocked = null; // å½“å‰ä¼šè¯é”å®šçš„æ¨¡å‹ï¼ˆé¦–æ¡ç”¨æˆ·æ¶ˆæ¯åé”å®šï¼‰
        let lastConfigId = null; // è®°å½•å½“å‰æ¿€æ´»çš„é…ç½®ï¼Œé˜²æ­¢è¯¯åˆ‡æ¢å¯¼è‡´æ¨¡å‹ä¸åŒ¹é…
        let modalAlertHandler = null; // é€šç”¨æ¨¡æ€å›è°ƒ

        // Custom Renderer for Marked
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            // Fix: Check hljs globally instead of highlight which caused errors
            const validLang = !!(language && typeof hljs !== 'undefined' && hljs.getLanguage(language));
            const highlighted = validLang && typeof hljs !== 'undefined'
                ? hljs.highlight(code, { language }).value 
                : (typeof hljs !== 'undefined' ? hljs.highlightAuto(code).value : code);
            const langShow = validLang ? language : 'text';
            
            return `<div class="hljs-container group">
                <div class="hljs-header">
                    <span class="font-mono">${langShow}</span>
                    <button onclick="copyCode(this)" class="opacity-0 group-hover:opacity-100 transition-opacity text-xs bg-white/10 hover:bg-white/20 px-2 py-0.5 rounded text-white cursor-pointer flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        å¤åˆ¶
                    </button>
                    <div class="hidden code-content">${encodeURIComponent(code)}</div>
                </div>
                <div class="hljs-body"><pre><code class="hljs ${language}">${highlighted}</code></pre></div>
            </div>`;
        };
        
        marked.setOptions({
            renderer: renderer,
            breaks: true,
            gfm: true
        });

        document.addEventListener('DOMContentLoaded', () => {
            const savedChats = localStorage.getItem('ai-chats-v2');
            if (savedChats) {
                chats = JSON.parse(savedChats);
                renderChatList();
                if (chats.length > 0) selectChat(chats[0].id);
            }
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#contextMenu')) hideContextMenu();
            });
            // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
            loadRagTagList();
            // åŠ è½½ LLM é…ç½®
            loadConfigs();
        });

        // åŠ è½½é…ç½®åˆ—è¡¨
        async function loadConfigs() {
            try {
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰é…ç½®å’Œå½“å‰æ¿€æ´»é…ç½®
                const [configsRes, activeRes] = await Promise.all([
                    fetch('/api/v1/llm/configs').then(r => r.json()),
                    fetch('/api/v1/llm/configs/active').then(r => r.json())
                ]);

                const select = document.getElementById('configSelect');
                select.innerHTML = '';
                
                let configs = [];
                if (configsRes.code === '0000' && configsRes.data) {
                    configs = configsRes.data;
                    configs.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.id;
                        // æ˜¾ç¤ºåç§°å’Œæä¾›å•†ç±»å‹
                        const icon = config.providerType === 'OLLAMA' ? 'ğŸ¦™' : (config.providerType === 'OPENAI' ? 'ğŸ¤–' : 'ğŸ§ ');
                        option.textContent = `${icon} ${config.name}`;
                        // ä¿å­˜æ¨¡å‹åˆ—è¡¨åˆ° dataset ä»¥ä¾¿åç»­ä½¿ç”¨
                        option.dataset.models = (config.models || []).join(',');
                        option.dataset.defaultModel = config.defaultModel || '';
                        select.appendChild(option);
                    });
                }
                
                // è®¾ç½®å½“å‰æ¿€æ´»é¡¹
                if (activeRes.code === '0000' && activeRes.data) {
                    select.value = activeRes.data.id;
                    updateModelOptions(activeRes.data);
                    lastConfigId = activeRes.data.id;
                } else if (configs.length > 0) {
                    // å¦‚æœæ²¡æœ‰æ¿€æ´»çš„ï¼ˆä¸å¤ªå¯èƒ½ï¼‰ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªä½†ä¸æ¿€æ´»ï¼ˆæˆ–è€…è‡ªåŠ¨æ¿€æ´»ï¼Ÿï¼‰
                    // è¿™é‡Œä»…UIé€‰ä¸­
                    select.value = configs[0].id;
                    updateModelOptions(configs[0]);
                    lastConfigId = configs[0].id;
                } else {
                     select.innerHTML = '<option disabled>æš‚æ— é…ç½®ï¼Œè¯·å»æ·»åŠ </option>';
                }
                // é…ç½®åˆ‡æ¢åè§£é™¤é”å®šï¼ŒæŒ‰æ–°é…ç½®é€‰æ‹©æ¨¡å‹
                modelLocked = null;
                const chat = chats.find(c => c.id === currentChatId);
                const selectedModel = document.getElementById('modelSelect').value || null;
                if (chat) {
                    chat.model = selectedModel;
                    saveChats();
                    renderChatList();
                }

            } catch (e) { console.error('åŠ è½½é…ç½®å¤±è´¥:', e); }
        }

        // åˆ‡æ¢é…ç½®
        async function switchConfig() {
            const select = document.getElementById('configSelect');
            const id = select.value;
            if (!id) return;
            
            // è·å–é€‰ä¸­é¡¹çš„æ¨¡å‹ä¿¡æ¯
            const option = select.options[select.selectedIndex];
            const models = option.dataset.models ? option.dataset.models.split(',').filter(Boolean) : [];
            const defaultModel = option.dataset.defaultModel;
            const currentChat = chats.find(c => c.id === currentChatId);
            const lockedModel = (currentChat && currentChat.messages.length > 0) ? (modelLocked || currentChat?.model || null) : null;

            // å¦‚æœå½“å‰ä¼šè¯å·²é”å®šæ¨¡å‹ä¸”æ–°é…ç½®ä¸åŒ…å«è¯¥æ¨¡å‹ï¼Œç¦æ­¢åˆ‡æ¢
            if (lockedModel && models.length > 0 && !models.includes(lockedModel)) {
                showModalAlert({
                    title: 'æ¨¡å‹ä¸å…¼å®¹',
                    message: `å½“å‰å¯¹è¯å·²é”å®šæ¨¡å‹ ${lockedModel}ï¼Œæ–°é…ç½®ä¸åŒ…å«è¯¥æ¨¡å‹ã€‚è¯·æ–°å»ºå¯¹è¯æˆ–åˆ‡æ¢åˆ°æ— é”å®šçš„å¯¹è¯åå†åˆ‡æ¢é…ç½®ã€‚`,
                    confirmText: 'æˆ‘çŸ¥é“äº†'
                });
                if (lastConfigId) {
                    select.value = lastConfigId;
                }
                return;
            }

            // æ›´æ–°æ¨¡å‹ä¸‹æ‹‰æ¡†
            updateModelOptions({ models, defaultModel });
            if (lockedModel) {
                setModelSelect(lockedModel);
            }

            try {
                // è°ƒç”¨åç«¯æ¿€æ´»æ¥å£
                await fetch(`/api/v1/llm/configs/${id}/activate`, { method: 'POST' });
                lastConfigId = id;
                // æç¤ºç”¨æˆ·ï¼ˆå¯é€‰ï¼Œæˆ–è€…é™é»˜æˆåŠŸï¼‰
                console.log('é…ç½®å·²åˆ‡æ¢:', option.text);
            } catch (e) {
                console.error('åˆ‡æ¢é…ç½®å¤±è´¥:', e);
                showModalAlert({
                    title: 'åˆ‡æ¢å¤±è´¥',
                    message: 'åˆ‡æ¢é…ç½®å¤±è´¥ï¼Œè¯·é‡è¯•',
                    confirmText: 'å…³é—­'
                });
            }
        }

        // çŸ¥è¯†åº“å¤šé€‰ç›¸å…³å˜é‡
        let allRagTags = [];          // æ‰€æœ‰å¯ç”¨çš„çŸ¥è¯†åº“åˆ—è¡¨
        let selectedRagTags = [];     // å·²é€‰ä¸­çš„çŸ¥è¯†åº“
        const MAX_RAG_TAGS = 10;      // æœ€å¤§é€‰æ‹©æ•°

        // åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨
        async function loadRagTagList() {
            try {
                const response = await fetch('/api/v1/rag/query_rag_tag_list');
                const result = await response.json();
                if (result.code === '0000' && result.data) {
                    allRagTags = result.data;
                    renderSelectedRagTags();
                }
            } catch (e) { console.error('åŠ è½½çŸ¥è¯†åº“åˆ—è¡¨å¤±è´¥:', e); }
        }

        // æ¸²æŸ“å·²é€‰æ ‡ç­¾
        function renderSelectedRagTags() {
            const container = document.getElementById('selectedRagTags');
            const countEl = document.getElementById('ragTagCount');
            const addBtn = document.getElementById('addRagTagBtn');

            countEl.textContent = `${selectedRagTags.length}/${MAX_RAG_TAGS}`;

            if (selectedRagTags.length === 0) {
                container.innerHTML = '<span class="text-[10px] text-gray-400 italic">æœªé€‰æ‹©çŸ¥è¯†åº“</span>';
            } else {
                container.innerHTML = selectedRagTags.map(tag => `
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-purple-200 text-purple-700 text-[10px] font-medium rounded-full">
                        ${escapeHtml(tag)}
                        <button onclick="removeRagTag('${escapeHtml(tag)}')" class="hover:text-purple-900 transition-colors">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </span>
                `).join('');
            }

            // è¾¾åˆ°ä¸Šé™æ—¶ç¦ç”¨æ·»åŠ æŒ‰é’®
            if (selectedRagTags.length >= MAX_RAG_TAGS) {
                addBtn.disabled = true;
                addBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                addBtn.disabled = false;
                addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // æ‰“å¼€çŸ¥è¯†åº“é€‰æ‹©å¼¹çª—
        function openRagTagSelector() {
            if (selectedRagTags.length >= MAX_RAG_TAGS) {
                showModalAlert({ title: 'å·²è¾¾ä¸Šé™', message: `æœ€å¤šåªèƒ½é€‰æ‹© ${MAX_RAG_TAGS} ä¸ªçŸ¥è¯†åº“`, confirmText: 'æˆ‘çŸ¥é“äº†' });
                return;
            }
            const availableTags = allRagTags.filter(t => !selectedRagTags.includes(t));
            if (availableTags.length === 0) {
                showModalAlert({ title: 'æ— å¯é€‰çŸ¥è¯†åº“', message: 'æ‰€æœ‰çŸ¥è¯†åº“å·²é€‰ä¸­æˆ–æš‚æ— å¯ç”¨çŸ¥è¯†åº“', confirmText: 'å¥½çš„' });
                return;
            }
            // ç®€å•å®ç°ï¼šä½¿ç”¨ prompt å¤šé€‰ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨æ¨¡æ€æ¡†ï¼‰
            const input = prompt(`å¯é€‰çŸ¥è¯†åº“ï¼š\n${availableTags.join('\n')}\n\nè¯·è¾“å…¥è¦æ·»åŠ çš„çŸ¥è¯†åº“åç§°ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ï¼š`);
            if (input) {
                const toAdd = input.split(',').map(s => s.trim()).filter(s => availableTags.includes(s));
                const remaining = MAX_RAG_TAGS - selectedRagTags.length;
                selectedRagTags.push(...toAdd.slice(0, remaining));
                renderSelectedRagTags();
            }
        }

        // ç§»é™¤å•ä¸ªæ ‡ç­¾
        function removeRagTag(tag) {
            selectedRagTags = selectedRagTags.filter(t => t !== tag);
            renderSelectedRagTags();
        }

        // å…¨é€‰
        function selectAllRagTags() {
            selectedRagTags = allRagTags.slice(0, MAX_RAG_TAGS);
            renderSelectedRagTags();
        }

        // æ¸…ç©º
        function clearAllRagTags() {
            selectedRagTags = [];
            renderSelectedRagTags();
        }

        // è·å–å·²é€‰çŸ¥è¯†åº“åˆ—è¡¨
        function getSelectedRagTags() {
            return selectedRagTags;
        }

        function createNewChat() {
            const initialSelect = document.getElementById('modelSelect');
            const initialModel = initialSelect && initialSelect.value ? initialSelect.value : null;
            const chat = { id: Date.now().toString(), title: 'æ–°å¯¹è¯', messages: [], createdAt: new Date().toISOString(), model: initialModel };
            chats.unshift(chat);
            saveChats();
            renderChatList();
            selectChat(chat.id);
        }

        function clearAllChats() {
            if (chats.length === 0) {
                // alert('æš‚æ— å¯¹è¯å¯æ¸…ç©º'); // Optional: remove alert too if strictly "no inquiries"
                return;
            }
            // Force clear without confirm
            chats = [];
            currentChatId = null;
            saveChats();
            renderChatList();
            renderMessages();
            document.getElementById('currentChatTitle').textContent = 'æ–°å¯¹è¯';
        }

        function selectChat(chatId) {
            currentChatId = chatId;
            renderChatList();
            renderMessages();
            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                document.getElementById('currentChatTitle').textContent = chat.title;
                // é¦–æ¡ç”¨æˆ·æ¶ˆæ¯åæ‰é”å®šæ¨¡å‹ï¼›æ— æ¶ˆæ¯æ—¶å…è®¸åˆ‡æ¢
                if (!chat.model) {
                    chat.model = document.getElementById('modelSelect').value || null;
                    saveChats();
                }
                const locked = chat.messages && chat.messages.length > 0;
                modelLocked = locked ? chat.model : null;
                if (chat.model) setModelSelect(chat.model);
            }
        }

        function deleteChat() {
            hideContextMenu();
            if (!contextMenuChatId) return;
            chats = chats.filter(c => c.id !== contextMenuChatId);
            saveChats();
            renderChatList();
            if (currentChatId === contextMenuChatId) {
                currentChatId = chats.length > 0 ? chats[0].id : null;
                currentChatId ? selectChat(currentChatId) : renderMessages();
            }
        }

        function renameChat() {
            hideContextMenu();
            if (!contextMenuChatId) return;
            const chat = chats.find(c => c.id === contextMenuChatId);
            if (!chat) return;
            const newTitle = prompt('è¾“å…¥æ–°åç§°:', chat.title);
            if (newTitle?.trim()) {
                chat.title = newTitle.trim();
                saveChats();
                renderChatList();
                if (currentChatId === contextMenuChatId) document.getElementById('currentChatTitle').textContent = chat.title;
            }
        }

        function showContextMenu(e, chatId) {
            e.preventDefault();
            e.stopPropagation();
            contextMenuChatId = chatId;
            const menu = document.getElementById('contextMenu');
            menu.classList.remove('hidden');
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('hidden');
            contextMenuChatId = null;
        }

        function saveChats() { localStorage.setItem('ai-chats-v2', JSON.stringify(chats)); }

        function renderChatList() {
            const container = document.getElementById('chatList');
            container.innerHTML = chats.map(chat => `
                <div class="group flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer mb-0.5 transition-colors ${chat.id === currentChatId ? 'bg-indigo-50 text-indigo-600' : 'hover:bg-gray-50 text-gray-700'}"
                    onclick="selectChat('${chat.id}')">
                    <div class="flex-1 min-w-0">
                        <span class="truncate block text-sm">${escapeHtml(chat.title)}</span>
                        ${chat.model ? `<span class="truncate block text-[10px] text-gray-400">æ¨¡å‹: ${escapeHtml(chat.model)}</span>` : ''}
                    </div>
                    <div class="flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="p-1 hover:bg-gray-200 rounded transition-colors" title="é‡å‘½å"
                            onclick="event.stopPropagation(); renameChatById('${chat.id}')">
                            <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                        </button>
                        <button class="p-1 hover:bg-red-100 rounded transition-colors" title="åˆ é™¤"
                            onclick="event.stopPropagation(); deleteChatById('${chat.id}')">
                            <svg class="w-3 h-3 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renameChatById(chatId) {
            const chat = chats.find(c => c.id === chatId);
            if (!chat) return;
            const newTitle = prompt('è¾“å…¥æ–°åç§°:', chat.title);
            if (newTitle?.trim()) {
                chat.title = newTitle.trim();
                saveChats();
                renderChatList();
                if (currentChatId === chatId) document.getElementById('currentChatTitle').textContent = chat.title;
            }
        }

        function deleteChatById(chatId) {
            // Simply delete without confirmation
            chats = chats.filter(c => c.id !== chatId);
            saveChats();
            renderChatList();
            if (currentChatId === chatId) {
                currentChatId = chats.length > 0 ? chats[0].id : null;
                currentChatId ? selectChat(currentChatId) : renderMessages();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            const chat = chats.find(c => c.id === currentChatId);
            
            if (!chat || chat.messages.length === 0) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center px-4">
                        <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center mb-6">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                            </svg>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ ï¼Ÿ</h2>
                        <p class="text-gray-500 text-sm">é€‰æ‹©å·¦ä¾§æ¨¡å‹ï¼Œå¼€å§‹ä¸ AI å¯¹è¯</p>
                    </div>`;
                return;
            }
            
            container.innerHTML = `<div class="py-6 px-6 space-y-6">` + 
                chat.messages.map((msg, i) => {
                    const isUser = msg.role === 'user';
                    // ç”¨æˆ·æ¶ˆæ¯åªåšç®€å•è½¬ä¹‰ï¼ŒAI æ¶ˆæ¯åš Markdown æ¸²æŸ“
                    // å†æ¬¡è¿‡æ»¤ï¼Œç¡®ä¿å®‰å…¨
                    const filteredContent = isUser ? msg.content : filterContent(msg.content, false); 
                    const contentHtml = isUser ? escapeHtml(msg.content) : marked.parse(filteredContent);
                    
                    return `
                    <div id="msg-${i}" class="message-enter flex flex-col ${isUser ? 'items-end' : 'items-start'} group">
                        <div class="${isUser 
                            ? 'w-fit max-w-[75%] bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-2xl rounded-br-md px-4 py-2.5 shadow-md text-sm' 
                            : 'bg-white border border-gray-100 text-gray-800 rounded-2xl rounded-bl-md px-4 py-2.5 max-w-3xl shadow-sm prose prose-sm prose-slate break-words text-sm [&>*:first-child]:mt-0 [&>*:last-child]:mb-0'}">
                             <div id="msg-content-${i}" class="${isUser ? 'whitespace-pre-wrap leading-relaxed' : ''}">${contentHtml}</div>
                        </div>
                        <div class="flex items-center gap-2 mt-1.5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 select-none">
                            <span class="text-[10px] text-gray-400">${formatTime(msg.timestamp)}</span>
                            <button onclick="copyText(this)" class="text-[10px] text-gray-400 hover:text-indigo-500 flex items-center gap-0.5 transition-colors" data-content="${encodeURIComponent(filteredContent)}">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                å¤åˆ¶
                            </button>
                        </div>
                    </div>`;
                }).join('') + `</div>`;
            scrollToBottom();
        }

        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function addMessage(role, content) {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            const isFirstUser = role === 'user' && chat.messages.length === 0;
            chat.messages.push({ role, content, timestamp: new Date().toISOString() });
            if (chat.messages.length === 1 && role === 'user') {
                chat.title = content.slice(0, 20) + (content.length > 20 ? '...' : '');
                document.getElementById('currentChatTitle').textContent = chat.title;
                renderChatList();
            }
            if (isFirstUser) {
                // é¦–æ¡ç”¨æˆ·æ¶ˆæ¯åé”å®šæ¨¡å‹
                const selectedModel = document.getElementById('modelSelect').value || chat.model || null;
                chat.model = selectedModel;
                modelLocked = selectedModel;
                if (selectedModel) setModelSelect(selectedModel);
            }
            saveChats();
        }

        function updateLastAIMessage(content) {
            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;
            const lastMsgIndex = chat.messages.length - 1;
            const lastMsg = chat.messages[lastMsgIndex];
            
            if (lastMsg?.role === 'assistant') {
                lastMsg.content = content;
                // saveChats(); // å‡å°‘IOé¢‘ç‡ï¼Œå¯ä»¥æ”¾åœ¨æµç»“æŸæ—¶ä¿å­˜
                
                // å±€éƒ¨æ›´æ–° DOMï¼Œé˜²æ­¢é—ªçƒ
                const contentDiv = document.getElementById(`msg-content-${lastMsgIndex}`);
                if (contentDiv) {
                    contentDiv.innerHTML = marked.parse(filterContent(content));
                    // è¿™é‡Œä¸éœ€è¦ scrollToBottomï¼Œé™¤éæ˜¯å¤§é‡å†…å®¹ï¼Œä¸”ç”¨æˆ·å·²åœ¨åº•éƒ¨
                    // scrollToBottom(); 
                } else {
                    renderMessages(); 
                }
            }
        }
        
        // å¤åˆ¶ä»£ç 
        function copyCode(btn) {
            const contentDiv = btn.parentElement.querySelector('.code-content');
            const code = decodeURIComponent(contentDiv.innerText);
            navigator.clipboard.writeText(code).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<svg class="w-3 h-3 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> å·²å¤åˆ¶`;
                setTimeout(() => btn.innerHTML = originalHtml, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showModalAlert({
                    title: 'å¤åˆ¶å¤±è´¥',
                    message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·ç¨åå†è¯•',
                    confirmText: 'å¥½çš„'
                });
            });
        }

        // å¤åˆ¶å…¨æ–‡
        function copyText(btn) {
            const content = decodeURIComponent(btn.dataset.content);
            navigator.clipboard.writeText(content).then(() => {
                const originalHtml = btn.innerHTML;
                btn.innerHTML = `<svg class="w-3 h-3 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> å·²å¤åˆ¶`;
                setTimeout(() => btn.innerHTML = originalHtml, 2000);
            });
        }

        function showModalAlert({ title = 'æç¤º', message = '', confirmText = 'ç¡®å®š', onConfirm = null }) {
            document.getElementById('modalAlertTitle').textContent = title;
            document.getElementById('modalAlertMessage').textContent = message;
            const btn = document.getElementById('modalAlertConfirm');
            btn.textContent = confirmText;
            modalAlertHandler = onConfirm;
            document.getElementById('modalAlert').classList.remove('hidden');
        }

        function hideModalAlert() {
            document.getElementById('modalAlert').classList.add('hidden');
            modalAlertHandler = null;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const alertBtn = document.getElementById('modalAlertConfirm');
            if (alertBtn) {
                alertBtn.onclick = () => {
                    if (typeof modalAlertHandler === 'function') {
                        modalAlertHandler();
                    }
                    hideModalAlert();
                };
            }
        });

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || isGenerating) return;

            if (document.getElementById('configSelect').options.length === 0) {
              showModalAlert({
                  title: 'æœªæ¿€æ´»é…ç½®',
                  message: 'è¯·å…ˆå»æ¨¡å‹é…ç½®é¡µé¢æ·»åŠ å¹¶æ¿€æ´»ä¸€ä¸ªé…ç½®ï¼',
                  confirmText: 'æˆ‘çŸ¥é“äº†'
              });
              return;
            }

            input.value = '';
            input.style.height = 'auto';
            input.focus();

            if (!currentChatId) createNewChat();

            addMessage('user', message);
            renderMessages();

            isGenerating = true;
            updateSendButton();
            addMessage('assistant', ''); 
            renderMessages();

            startStreamRequest(message);
        }

        function updateModelOptions(config) {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            
            if (config.models && config.models.length > 0) {
                config.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    select.appendChild(option);
                });
                
                if (config.defaultModel && config.models.includes(config.defaultModel)) {
                    select.value = config.defaultModel;
                } else {
                    select.value = config.models[0];
                }
            } else {
                select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹</option>';
                select.value = '';
            }
        }

        function setModelSelect(value) {
            const select = document.getElementById('modelSelect');
            if (!select) return;
            const options = Array.from(select.options).map(o => o.value);
            if (value && options.includes(value)) {
                select.value = value;
            }
        }

        function onModelChange() {
            const select = document.getElementById('modelSelect');
            const chosen = select.value;
            if (modelLocked && chosen !== modelLocked) {
                // æ¢å¤é”å®šæ¨¡å‹ï¼Œå¹¶æç¤ºç”¨æˆ·éœ€è¦æ–°å»ºä¼šè¯
                setModelSelect(modelLocked);
                showModalAlert({
                    title: 'åˆ‡æ¢å—é™',
                    message: 'åŒä¸€ä¸ªä¼šè¯åªèƒ½ä½¿ç”¨ä¸€ä¸ªæ¨¡å‹ã€‚å¦‚éœ€åˆ‡æ¢æ¨¡å‹ï¼Œè¯·æ–°å»ºå¯¹è¯ã€‚',
                    confirmText: 'å¥½çš„'
                });
                return;
            }
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.model = chosen;
                saveChats();
                renderChatList();
            }
        }

        function startStreamRequest(message) {
            // è·å–å·²é€‰çŸ¥è¯†åº“åˆ—è¡¨
            const ragTags = getSelectedRagTags();
            const model = modelLocked || document.getElementById('modelSelect').value;
            const chat = chats.find(c => c.id === currentChatId);
            if (chat) {
                chat.model = model; // ç¡®ä¿ä¼šè¯è®°å½•æ‰€é€‰æ¨¡å‹
                saveChats();
            }
            if (!model) {
                showModalAlert({
                    title: 'è¯·é€‰æ‹©æ¨¡å‹',
                    message: 'å½“å‰ä¼šè¯æœªé€‰æ‹©æ¨¡å‹ï¼Œè¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©æ¨¡å‹åå†å‘é€ã€‚',
                    confirmText: 'å¥½çš„'
                });
                isGenerating = false;
                updateSendButton();
                return;
            }

            // æ„å»º URLï¼šæ”¯æŒå¤šçŸ¥è¯†åº“
            let url;
            if (ragTags.length > 0) {
                const ragTagsParam = ragTags.map(t => `ragTags=${encodeURIComponent(t)}`).join('&');
                url = `/api/v1/ai/generate_stream_rag?${ragTagsParam}&message=${encodeURIComponent(message)}&model=${encodeURIComponent(model)}`;
            } else {
                url = `/api/v1/ai/generate_stream?message=${encodeURIComponent(message)}&model=${encodeURIComponent(model)}`;
            }

            currentEventSource = new EventSource(url);
            let fullContent = '';

            currentEventSource.onmessage = (event) => {
                const rawData = event.data;
                // Fix: Robust JSON stream parsing
                // Split concatenated JSON objects directly if they appear as `}{`
                // This is a common issue with some stream buffers or proxies
                let chunks = [];
                let start = 0;
                while (start < rawData.length) {
                     let end = rawData.indexOf('}{', start);
                     if (end === -1) end = rawData.length;
                     else end += 1; // Include the closing brace
                     chunks.push(rawData.substring(start, end));
                     start = end;
                }

                chunks.forEach(data => {
                    try {
                        const parsed = JSON.parse(data);
                        // Recursively extracting text
                        function extractContent(obj) {
                            if (typeof obj === 'string') return obj;
                            if (!obj || typeof obj !== 'object') return '';
                            
                            // Top priority fields
                            if (obj.text) return obj.text;
                            if (obj.content) return obj.content;
                            
                            // Nested fields
                            if (obj.output) return extractContent(obj.output);
                            if (obj.result) return extractContent(obj.result);
                            if (obj.data) return extractContent(obj.data);
                            // OpenAI style
                            if (obj.choices && obj.choices[0]) return extractContent(obj.choices[0].delta || obj.choices[0].message);
                            
                            return ''; // Don't return JSON string fallback, it causes raw JSON display
                        }

                        const content = extractContent(parsed);
                        if (content) {
                            fullContent += content;
                        }
                    } catch (e) {
                        // If parse fails, it might be raw text or special signals
                        if (data !== '[DONE]') {
                             // Only append if it looks like safe text, avoiding partial JSON fragments
                             if (!data.trim().startsWith('{') && !data.trim().startsWith('}')) {
                                fullContent += data;
                             }
                        }
                    }
                });
                updateLastAIMessage(fullContent);
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ (å¯é€‰ï¼šå½“ç”¨æˆ·æ²¡æœ‰å‘ä¸Šæ»šåŠ¨æ—¶)
                scrollToBottom();
            };

            currentEventSource.onerror = (err) => {
                console.error('Stream Error:', err);
                stopGeneration();
            };
        }

        // è¿‡æ»¤ <think> å†…å®¹ï¼Œä½†ä¿ç•™ Markdown æ ¼å¼
        function filterContent(content, isRendering) {
             if (!content) return '';
             // åªæ›¿æ¢ <think> æ ‡ç­¾å—ï¼Œä¿ç•™å…¶ä»–æ‰€æœ‰å­—ç¬¦
             // 1. å¦‚æœæœ‰å®Œæ•´çš„ <think>...</think>ï¼Œå»æ‰å®ƒ
             let result = content.replace(/<think>[\s\S]*?<\/think>/g, '');
             
             // 2. å¦‚æœåªæœ‰å¼€å§‹æ ‡ç­¾ <think>ï¼ˆæµå¼æœªç»“æŸï¼‰ï¼Œå»æ‰å¼€å§‹æ ‡ç­¾åŠä¹‹åçš„æ‰€æœ‰å†…å®¹
             const thinkStart = result.indexOf('<think>');
             if (thinkStart !== -1) {
                 result = result.substring(0, thinkStart);
             }
             
             // 3. ç®€å•çš„æ ‡ç­¾æ¸…ç†ï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰ï¼Œä½†ä¸è¦è¯¯ä¼¤ Markdown
             // ç§»é™¤å­¤ç«‹çš„æ ‡ç­¾
             result = result.replace(/<\/?think>/g, '');
             
             return result.trim();
        }
        
        function stopGeneration() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            isGenerating = false;
            saveChats(); // ç”Ÿæˆåœæ­¢æ—¶ä¿å­˜
            updateSendButton();
        }

        function updateSendButton() {
            const sendIcon = document.getElementById('sendIcon');
            const loadingIcon = document.getElementById('loadingIcon');
            const btn = document.getElementById('sendButton');
            
            if (isGenerating) {
                sendIcon.classList.add('hidden');
                loadingIcon.classList.remove('hidden');
                btn.onclick = stopGeneration;
                btn.classList.add('from-red-500', 'to-pink-600');
                btn.classList.remove('from-indigo-500', 'to-purple-600');
            } else {
                sendIcon.classList.remove('hidden');
                loadingIcon.classList.add('hidden');
                btn.onclick = sendMessage;
                btn.classList.remove('from-red-500', 'to-pink-600');
                btn.classList.add('from-indigo-500', 'to-purple-600');
            }
        }

        function handleKeyDown(e) {
            if (e.isComposing || e.keyCode === 229) return;
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('z-20');
            sidebar.classList.toggle('h-full');
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
